<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Sistema do Professor</title>
    <link rel="stylesheet" href="styles.css">
    <script src="shared.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>
</head>
<body>
    <!-- TELA DE LOGIN/CADASTRO -->
    <div id="authContainer" class="auth-screen">
        <div class="auth-box">
            <h2>üîê Login</h2>
            <form onsubmit="fazerLogin(event)">
                <label>Email: <input type="email" id="loginEmail" required></label>
                <label>Senha: 
                    <div class="password-wrapper">
                        <input type="password" id="loginSenha" required style="padding-right: 35px;">
                        <button type="button" class="toggle-password" onclick="toggleSenha('loginSenha', this)">üëÅÔ∏è</button>
                    </div>
                </label>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 10px;">Entrar</button>
            </form>
            <span class="auth-link" onclick="renderCadastro()">N√£o tem conta? Cadastre-se</span>
        </div>
    </div>

    <!-- ESTRUTURA DA APLICA√á√ÉO (Adicionada para suportar o JS) -->
    <div id="appContainer" style="display:none;">
        <div class="container">
            <header>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h1>üìö Sistema Escolar</h1>
                        <div id="painelSubtitle"></div>
                    </div>
                    <div style="text-align: right;">
                        <div class="date-info" id="currentDate"></div>
                        <button class="btn btn-sm btn-danger" onclick="logout()" style="margin-top: 5px;">Sair</button>
                    </div>
                </div>
            </header>

            <nav>
                <!-- Bot√µes injetados via JS -->
            </nav>

            <!-- TELAS -->
            <div id="dashboard" class="screen">
                <div class="grid">
                    <div class="card">
                        <h2>üìÖ Aulas de Hoje</h2>
                        <div id="aulasHoje"></div>
                    </div>
                    <div class="card">
                        <h2>ü§ù Reuni√µes de Hoje</h2>
                        <div id="reunioesHoje"></div>
                    </div>
                    <div class="card">
                        <h2>üë• Tutorias/A√ß√µes</h2>
                        <div id="tutoriasHoje"></div>
                    </div>
                </div>
                <div class="card">
                    <h2>‚ö†Ô∏è Alertas</h2>
                    <div id="alertas"></div>
                </div>
            </div>

            <div id="turmas" class="screen">
                <div class="card">
                    <h2>Minhas Turmas</h2>
                    <button class="btn btn-primary" onclick="abrirModalNovaTurma()">+ Nova Turma</button>
                    <div id="listaTurmas" style="margin-top: 15px;"></div>
                </div>
            </div>

            <div id="tutoria" class="screen">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2>üéì Tutoria</h2>
                        <button id="btnConfigTutoria" class="btn btn-secondary" onclick="alert('Configura√ß√µes de Tutoria')">‚öôÔ∏è Config</button>
                    </div>
                    <div class="grid">
                        <div>
                            <h3>Meus Tutorados</h3>
                            <button class="btn btn-primary btn-sm" onclick="showModal('modalNovoTutorado')">+ Novo Tutorado</button>
                            <div id="listaTutorados" style="margin-top: 10px;"></div>
                        </div>
                        <div>
                            <h3>Pr√≥ximos Encontros</h3>
                            <button class="btn btn-primary btn-sm btn-registrar-extra" onclick="showModal('modalNovoEncontro')">+ Registrar Encontro</button>
                            <button class="btn btn-secondary btn-sm" onclick="showModal('modalGerarAgendamento')">üìÖ Agendar</button>
                            <div id="listaEncontros" style="margin-top: 10px;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="agenda" class="screen">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0;">üìÖ Agenda</h2>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-secondary" onclick="alternarVisualizacao('mes')" id="btnVisMes">M√™s</button>
                            <button class="btn btn-secondary" onclick="alternarVisualizacao('semana')" id="btnVisSemana">Semana</button>
                            <button class="btn btn-primary" onclick="abrirModalEventoSlot(getTodayString(), '', '')">+ Novo Evento</button>
                            <button class="btn btn-secondary" onclick="imprimirAgendaMensal()">üñ®Ô∏è Imprimir</button>
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: #f7fafc; padding: 15px; border-radius: 8px;">
                        <button class="btn btn-secondary" onclick="navegarPeriodo(-1)">‚Üê Anterior</button>
                        <h3 id="tituloCalendario" style="margin: 0;"></h3>
                        <button class="btn btn-secondary" onclick="navegarPeriodo(1)">Pr√≥ximo ‚Üí</button>
                    </div>

                    <div id="calendarioView"></div>
                    
                    <div style="margin-top: 30px;">
                        <h3>Lista de Eventos</h3>
                        <div id="listaEventos"></div>
                    </div>
                </div>
            </div>

            <!-- DETALHES -->
            <div id="turmaDetalhe" class="screen">
                <div class="card">
                    <button class="btn btn-secondary" onclick="showScreen('turmas')">‚Üê Voltar</button>
                    <h2 id="turmaDetalheTitulo" style="margin-top: 15px;">Detalhes da Turma</h2>
                    <div id="turmaStats" class="stats"></div>
                    
                    <nav style="margin-bottom: 20px; border-bottom: 1px solid #e2e8f0; padding-bottom: 10px;">
                        <!-- Tabs injetadas via JS -->
                    </nav>

                    <div id="tabEstudantes" class="turma-tab"></div>
                    <div id="tabChamada" class="turma-tab" style="display:none;"></div>
                    <div id="tabAtrasos" class="turma-tab" style="display:none;"></div>
                    <div id="tabTrabalhos" class="turma-tab" style="display:none;"></div>
                    <div id="tabCompensacoes" class="turma-tab" style="display:none;"></div>
                    <div id="tabOcorrencias" class="turma-tab" style="display:none;"></div>
                    <div id="tabConfiguracoes" class="turma-tab" style="display:none;"></div>
                </div>
            </div>

            <div id="tutoradoDetalhe" class="screen">
                <div class="card">
                    <button class="btn btn-secondary" onclick="showScreen('tutoria')">‚Üê Voltar</button>
                    <h2 id="tutoradoFichaNome" style="margin-top: 15px;">Nome do Tutorado</h2>
                    <div class="grid">
                        <div>
                            <h3>Agendamentos Futuros</h3>
                            <div id="tutoradoFichaAgendamentos"></div>
                        </div>
                        <div>
                            <h3>Hist√≥rico de Encontros</h3>
                            <div id="tutoradoFichaHistorico"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="estudanteDetalhe" class="screen">
                <div class="card">
                    <button class="btn btn-secondary" onclick="showScreen('turmaDetalhe')">‚Üê Voltar para Turma</button>
                    <h2 id="estudanteGeralNome" style="margin-top: 15px;">Nome do Estudante</h2>
                    
                    <div class="grid">
                        <div class="card" style="background: #f7fafc;">
                            <h3>Frequ√™ncia</h3>
                            <div id="estudanteGeralFrequencia"></div>
                        </div>
                        <div class="card" style="background: #fff5f5;">
                            <h3>Atrasos</h3>
                            <div id="estudanteGeralAtrasos"></div>
                        </div>
                    </div>

                    <h3>Notas e Trabalhos</h3>
                    <div id="estudanteGeralNotas"></div>

                    <h3>Ocorr√™ncias</h3>
                    <div id="estudanteGeralOcorrencias"></div>

                    <h3>Compensa√ß√µes</h3>
                    <div id="estudanteGeralCompensacoes"></div>
                </div>
            </div>

            <div id="relatorioImpressao" class="screen" style="background: white; min-height: 100vh;">
                <button class="btn btn-secondary no-print" onclick="showScreen('turmaDetalhe')" style="margin: 20px;">‚Üê Voltar</button>
                <button class="btn btn-primary no-print" onclick="window.print()" style="margin: 20px;">üñ®Ô∏è Imprimir</button>
                <div id="conteudoRelatorio"></div>
            </div>
        </div>
    </div>

    <div id="adminContainer" style="display:none;">
        <div class="container">
            <header>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h1>üõ°Ô∏è Painel Super Admin</h1>
                    <button class="btn btn-danger" onclick="logout()">Sair</button>
                </div>
            </header>
            <div id="adminEscolasScreen">
                <div class="card">
                    <h2>Escolas Cadastradas</h2>
                    <button class="btn btn-primary" onclick="abrirModalEscola()">+ Nova Escola</button>
                    <div id="listaEscolasAdmin" style="margin-top: 15px;"></div>
                </div>
            </div>
            <div id="adminEscolaDetalheScreen" style="display:none;"></div>
        </div>
    </div>

    <!-- MODAIS (Placeholders essenciais) -->
    <div id="modalNovaTurma" class="modal"><div class="modal-content"><div class="modal-header"><h2 id="tituloModalTurma">Nova Turma</h2><button class="close-btn" onclick="closeModal('modalNovaTurma')">√ó</button></div><form onsubmit="salvarTurma(event)"><input type="hidden" id="turmaId"><div id="containerTurmaAnoInput"><label>Ano/S√©rie:<input type="text" id="turmaAno"></label></div><div id="containerTurmaAnoSelect" style="display:none;"><label>Turma:<select id="turmaAnoSelect"></select></label></div><div id="divTurmaDisciplina"><label>Disciplina:<input type="text" id="turmaDisciplina"></label></div><label>Turno:<select id="turmaTurno"><option value="Manh√£">Manh√£</option><option value="Tarde">Tarde</option><option value="Noite">Noite</option></select></label><button type="submit" class="btn btn-primary">Salvar</button></form></div></div>
    
    <div id="modalNovoEstudante" class="modal"><div class="modal-content"><div class="modal-header"><h2>Novo Estudante</h2><button class="close-btn" onclick="closeModal('modalNovoEstudante')">√ó</button></div><form onsubmit="salvarEstudante(event)"><label>Nome Completo:<input type="text" id="estudanteNome" required></label><label>Status:<select id="estudanteStatus"><option value="Ativo">Ativo</option></select></label><button type="submit" class="btn btn-primary">Salvar</button></form></div></div>
    
    <div id="modalImportarEstudantes" class="modal"><div class="modal-content"><div class="modal-header"><h2>Importar CSV</h2><button class="close-btn" onclick="closeModal('modalImportarEstudantes')">√ó</button></div><form onsubmit="importarEstudantes(event)"><label>Arquivo CSV:<input type="file" id="arquivoEstudantes" accept=".csv" required></label><p style="font-size:12px; color:#666;">Formato: Nome Completo;Status</p><button type="submit" class="btn btn-success">Importar</button></form></div></div>

    <div id="modalNovoTrabalho" class="modal"><div class="modal-content"><div class="modal-header"><h2>Novo Trabalho</h2><button class="close-btn" onclick="closeModal('modalNovoTrabalho')">√ó</button></div><form onsubmit="salvarTrabalho(event)"><label>T√≠tulo:<input type="text" id="trabalhoTitulo" required></label><label>Peso:<input type="number" id="trabalhoPeso" step="0.1" value="1.0" required></label><button type="submit" class="btn btn-primary">Salvar</button></form></div></div>
    
    <div id="modalLancarNotas" class="modal"><div class="modal-content"><div class="modal-header"><h2>Lan√ßar Notas</h2><button class="close-btn" onclick="closeModal('modalLancarNotas')">√ó</button></div><div id="conteudoLancarNotas"></div></div></div>

    <div id="modalNovoEvento" class="modal"><div class="modal-content"><div class="modal-header"><h2>Novo Evento</h2><button class="close-btn" onclick="closeModal('modalNovoEvento')">√ó</button></div><form onsubmit="salvarEvento(event)"><label>Tipo:<select id="eventoTipo" required><option value="Reuni√£o">Reuni√£o</option><option value="Aula">Aula</option><option value="Pessoal">Pessoal</option></select></label><div id="divEventoTurma" style="display:none;"><label>Turma:<select id="eventoTurmaSelect"></select></label></div><label>T√≠tulo:<input type="text" id="eventoTitulo" required></label><div class="form-row"><label>Data:<input type="date" id="eventoData" required></label><label>In√≠cio:<input type="time" id="eventoHoraInicio" required></label><label>Fim:<input type="time" id="eventoHoraFim" required></label></div><label>Anota√ß√µes:<textarea id="eventoAnotacoes"></textarea></label><label>Recorr√™ncia:<select id="eventoRecorrenciaTipo" onchange="toggleRecorrenciaUI()"><option value="nao">N√£o repetir</option><option value="semanal">Semanalmente</option><option value="mensal">Mensalmente</option><option value="personalizado">Personalizado</option></select></label><div id="divRecorrenciaFim" style="display:none;"><label>Repetir at√©:<input type="date" id="eventoRecorrenciaFim"></label></div><div id="divRecorrenciaPersonalizada" style="display:none;"><label>Dias da Semana:</label><div style="display:flex; gap:5px;"><label><input type="checkbox" name="diaSemana" value="1"> Seg</label><label><input type="checkbox" name="diaSemana" value="2"> Ter</label><label><input type="checkbox" name="diaSemana" value="3"> Qua</label><label><input type="checkbox" name="diaSemana" value="4"> Qui</label><label><input type="checkbox" name="diaSemana" value="5"> Sex</label></div></div><button type="submit" class="btn btn-primary">Salvar</button></form></div></div>

    <div id="modalDetalhesEvento" class="modal"><div class="modal-content"><div class="modal-header"><h2>Detalhes do Evento</h2><button class="close-btn" onclick="closeModal('modalDetalhesEvento')">√ó</button></div><form onsubmit="salvarDetalhesEvento(event)"><input type="hidden" id="detalheEventoId"><input type="hidden" id="detalheEventoTipo"><label>T√≠tulo:<input type="text" id="detalheEventoTitulo"></label><div class="form-row"><label>Data:<input type="date" id="detalheEventoData"></label><label>In√≠cio:<input type="time" id="detalheEventoInicio"></label><label>Fim:<input type="time" id="detalheEventoFim"></label></div><label>Anota√ß√µes:<textarea id="detalheEventoAnotacoes"></textarea></label><div style="display:flex; justify-content:space-between; margin-top:15px;"><button type="button" class="btn btn-danger" onclick="excluirEventoAtual()">Excluir</button><button type="submit" class="btn btn-primary">Salvar Altera√ß√µes</button></div></form></div></div>

    <div id="modalNovoTutorado" class="modal"><div class="modal-content"><div class="modal-header"><h2>Novo Tutorado</h2><button class="close-btn" onclick="closeModal('modalNovoTutorado')">√ó</button></div><form onsubmit="salvarTutorado(event)"><label>Nome:<input type="text" id="tutoradoNome" required></label><label>Turma:<input type="text" id="tutoradoTurma" required></label><button type="submit" class="btn btn-primary">Salvar</button></form></div></div>

    <div id="modalNovoEncontro" class="modal"><div class="modal-content"><div class="modal-header"><h2>Registrar Encontro</h2><button class="close-btn" onclick="closeModal('modalNovoEncontro')">√ó</button></div><form onsubmit="salvarEncontro(event)"><label>Tutorado:<select id="encontroTutorado" required></select></label><label>Data:<input type="date" id="encontroData" required></label><label>Tema:<input type="text" id="encontroTema" required></label><label>Resumo:<textarea id="encontroResumo" required></textarea></label><button type="submit" class="btn btn-primary">Salvar</button></form></div></div>

    <div id="modalGerarAgendamento" class="modal"><div class="modal-content"><div class="modal-header"><h2>Agendamento Autom√°tico</h2><button class="close-btn" onclick="closeModal('modalGerarAgendamento')">√ó</button></div><form onsubmit="previewHorariosAuto(event)"><label>In√≠cio:<input type="date" id="agendamentoInicio" required></label><label>Hora In√≠cio (se manual):<input type="time" id="agendamentoHoraInicio"></label><label>Dura√ß√£o (min):<input type="number" id="agendamentoDuracao" value="20"></label><label>Recorr√™ncia:<select id="agendamentoRecorrenciaTipo" onchange="toggleAgendamentoRecorrenciaUI()"><option value="nao">Apenas uma vez</option><option value="semanal">Semanal</option><option value="mensal">Mensal</option><option value="personalizado">Dias Espec√≠ficos</option></select></label><div id="divAgendamentoRecorrenciaFim" style="display:none;"><label>At√©:<input type="date" id="agendamentoRecorrenciaFim"></label></div><div id="divAgendamentoRecorrenciaPersonalizada" style="display:none;"><label>Dias:</label><div style="display:flex; gap:5px;"><label><input type="checkbox" name="diaAgendamento" value="1"> Seg</label><label><input type="checkbox" name="diaAgendamento" value="2"> Ter</label><label><input type="checkbox" name="diaAgendamento" value="3"> Qua</label><label><input type="checkbox" name="diaAgendamento" value="4"> Qui</label><label><input type="checkbox" name="diaAgendamento" value="5"> Sex</label></div></div><label><input type="checkbox" id="usarGradeTutoria"> Usar Grade de Tutoria da Escola</label><button type="submit" class="btn btn-secondary">Gerar Preview</button></form><div id="areaPreviewAgendamento" style="display:none; margin-top:15px;"><div style="display:flex; justify-content:space-between;"><h4>Preview (<span id="qtdHorariosGerados">0</span> hor√°rios)</h4><div><button onclick="mudarSemanaPreview(-1)">‚Üê</button><span id="previewSemanaTexto" style="font-size:12px;"></span><button onclick="mudarSemanaPreview(1)">‚Üí</button></div></div><div id="listaHorariosPreview" style="max-height:150px; overflow-y:auto; border:1px solid #eee;"></div><button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="confirmarDistribuicaoAuto()">Confirmar Agendamento</button></div></div></div>

    <div id="modalListaAgendamentos" class="modal"><div class="modal-content"><div class="modal-header"><h2>Agendamentos Futuros</h2><button class="close-btn" onclick="closeModal('modalListaAgendamentos')">√ó</button></div><div id="listaAgendamentosConteudo"></div></div></div>

    <div id="modalRelatorioFaltas" class="modal"><div class="modal-content"><div class="modal-header"><h2>Relat√≥rio de Faltas</h2><button class="close-btn" onclick="closeModal('modalRelatorioFaltas')">√ó</button></div><div id="conteudoRelatorioFaltas"></div></div></div>

    <div id="modalNovoRegistroGestao" class="modal"><div class="modal-content"><div class="modal-header"><h2>Novo Registro Administrativo</h2><button class="close-btn" onclick="closeModal('modalNovoRegistroGestao')">√ó</button></div><div id="formRegistroGestaoConteudo"></div></div></div>

    <div id="modalAdminEscola" class="modal"><div class="modal-content"><div class="modal-header"><h2 id="tituloModalEscola">Escola</h2><button class="close-btn" onclick="closeModal('modalAdminEscola')">√ó</button></div><form onsubmit="salvarEscola(event)"><input type="hidden" id="adminEscolaId"><label>Nome:<input type="text" id="adminEscolaNome" required></label><label>Endere√ßo:<input type="text" id="adminEscolaEndereco"></label><button type="submit" class="btn btn-primary">Salvar</button></form></div></div>

    <div id="modalAdminUsuario" class="modal"><div class="modal-content"><div class="modal-header"><h2 id="tituloModalUsuarioAdmin">Usu√°rio</h2><button class="close-btn" onclick="closeModal('modalAdminUsuario')">√ó</button></div><form onsubmit="salvarUsuarioAdmin(event)"><input type="hidden" id="adminUsuarioId"><label>Nome:<input type="text" id="adminUsuarioNome" required></label><label>Email:<input type="email" id="adminUsuarioEmail" required></label><label>Senha:<input type="text" id="adminUsuarioSenha" placeholder="Deixe em branco para manter"></label><label>Perfil:<select id="adminUsuarioRole"><option value="professor">Professor</option><option value="gestor">Gestor</option></select></label><button type="submit" class="btn btn-primary">Salvar</button></form></div></div>

    <script>
        // --- CONFIGURA√á√ÉO H√çBRIDA (LOCAL vs FIREBASE) ---
        
        // Detecta se est√° rodando localmente ou em produ√ß√£o
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const USE_FIREBASE = !isLocalhost; // Configura√ß√£o original (H√≠brida)
        // const USE_FIREBASE = true; // FOR√áADO: Usar Firebase mesmo localmente para testes

        let db; // Vari√°vel global para o Firestore

        if (USE_FIREBASE) {
            const firebaseConfig = {
                apiKey: "AIzaSyCOP_TE6YvVkg9E2DFuwfF7jDkBgxyc8ls",
                authDomain: "profsis3.firebaseapp.com",
                databaseURL: "https://profsis3-default-rtdb.firebaseio.com",
                projectId: "profsis3",
                storageBucket: "profsis3.firebasestorage.app",
                messagingSenderId: "944272675889",
                appId: "1:944272675889:web:2afc6a869f363aefedf110",
                measurementId: "G-2EJ3T4DPLG"
            };
            
            // Inicializa Firebase
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            firebase.analytics();
            console.log("üî• Modo Produ√ß√£o: Firebase Ativado");
        } else {
            console.log("üíª Modo Desenvolvimento: LocalStorage Ativado");
        }

        // Fun√ß√µes Auxiliares de Dados (Abstra√ß√£o)
        async function getData(collectionName, docId) {
            if (USE_FIREBASE) {
                try {
                    const doc = await db.collection(collectionName).doc(String(docId)).get();
                    return doc.exists ? doc.data() : null;
                } catch (error) {
                    console.error("Erro ao buscar no Firebase:", error);
                    return null;
                }
            } else {
                // Comportamento LocalStorage
                const key = collectionName === 'users' ? 'app_users' : docId; // Adapta√ß√£o simples
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            }
        }

        async function saveData(collectionName, docId, dataObj) {
            if (USE_FIREBASE) {
                try {
                    await db.collection(collectionName).doc(String(docId)).set(dataObj);
                } catch (error) {
                    console.error("Erro ao salvar no Firebase:", error);
                }
            } else {
                // Comportamento LocalStorage
                const key = collectionName === 'users' ? 'app_users' : docId;
                // Para users no localStorage, precisamos tratar array vs objeto, 
                // mas para simplificar a migra√ß√£o, vamos manter a l√≥gica original nos handlers
                localStorage.setItem(key, JSON.stringify(dataObj));
            }
        }

        // --- FIM CONFIGURA√á√ÉO ---

        function renderCadastro() {
            const schools = JSON.parse(localStorage.getItem('app_schools') || '[]');
            const options = schools.map(s => `<option value="${s.id}">${s.nome}</option>`).join('');

            document.getElementById('authContainer').innerHTML = `
                <div class="auth-box">
                    <h2>üìù Cadastro</h2>
                    <form onsubmit="fazerCadastro(event)">
                        <label>Nome: <input type="text" id="cadNome" required></label>
                        <label>Email: <input type="email" id="cadEmail" required></label>
                        <label>Escola: 
                            <select id="cadEscola" required>
                                <option value="">Selecione sua escola...</option>
                                ${options}
                            </select>
                        </label>
                        <label>Senha: 
                            <div class="password-wrapper">
                                <input type="password" id="cadSenha" required style="padding-right: 35px;">
                                <button type="button" class="toggle-password" onclick="toggleSenha('cadSenha', this)">üëÅÔ∏è</button>
                            </div>
                        </label>
                        <button type="submit" class="btn btn-success" style="width: 100%; margin-top: 10px;">Criar Conta</button>
                    </form>
                    <span class="auth-link" onclick="location.reload()">J√° tem conta? Fa√ßa Login</span>
                </div>
            `;
        }

        function toggleSenha(inputId, btn) {
            const input = document.getElementById(inputId);
            if (input.type === 'password') {
                input.type = 'text';
                btn.textContent = 'üôà';
            } else {
                input.type = 'password';
                btn.textContent = 'üëÅÔ∏è';
            }
        }

        async function fazerCadastro(e) {
            e.preventDefault();
            const nome = document.getElementById('cadNome').value;
            const email = document.getElementById('cadEmail').value;
            const senha = document.getElementById('cadSenha').value;
            const schoolId = document.getElementById('cadEscola').value;

            let users = [];
            if (USE_FIREBASE) {
                const usersData = await getData('system', 'users_list'); // Usamos um doc √∫nico para lista de usu√°rios simplificada
                users = usersData ? usersData.list : [];
            } else {
                users = JSON.parse(localStorage.getItem('app_users') || '[]');
            }
            
            if (users.find(u => u.email === email)) {
                alert('Este email j√° est√° cadastrado!');
                return;
            }

            const newUser = { id: Date.now(), nome, email, senha, schoolId: schoolId };
            users.push(newUser);
            
            if (USE_FIREBASE) {
                await saveData('system', 'users_list', { list: users });
            } else {
                localStorage.setItem('app_users', JSON.stringify(users));
            }

            alert('Cadastro realizado com sucesso! Fa√ßa login.');
            location.reload();
        }

        async function fazerLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const senha = document.getElementById('loginSenha').value;

            // Super Admin Check
            if (email === 'rafael@adm' && senha === 'Amor@9391') {
                localStorage.setItem('app_current_user', JSON.stringify({ id: 'admin', nome: 'Super Admin', email: email, role: 'super_admin' }));
                iniciarAdmin(); // CORRE√á√ÉO: Chama a fun√ß√£o interna em vez de redirecionar
                return;
            }

            let users = [];
            if (USE_FIREBASE) {
                const usersData = await getData('system', 'users_list');
                users = usersData ? usersData.list : [];
            } else {
                users = JSON.parse(localStorage.getItem('app_users') || '[]');
            }

            const user = users.find(u => u.email === email && u.senha === senha);

            if (user) {
                if (user.mustChangePassword) {
                    renderTrocarSenha(user);
                } else {
                    localStorage.setItem('app_current_user', JSON.stringify(user));
                    iniciarApp(); // CORRE√á√ÉO: Inicia a SPA em vez de redirecionar
                }
            } else {
                alert('Email ou senha incorretos.');
            }
        }

        function renderTrocarSenha(user) {
            document.getElementById('authContainer').innerHTML = `
                <div class="auth-box">
                    <h2>üîê Nova Senha</h2>
                    <p style="text-align: center; margin-bottom: 20px; color: #4a5568;">
                        Ol√°, ${user.nome}.<br>Como este √© seu primeiro acesso, voc√™ precisa definir uma nova senha.
                    </p>
                    <form onsubmit="confirmarNovaSenha(event, ${user.id})">
                        <label>Nova Senha: 
                            <div class="password-wrapper">
                                <input type="password" id="novaSenha" required style="padding-right: 35px;">
                                <button type="button" class="toggle-password" onclick="toggleSenha('novaSenha', this)">üëÅÔ∏è</button>
                            </div>
                        </label>
                        <label>Confirmar Senha: 
                            <input type="password" id="confirmaSenha" required>
                        </label>
                        <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 10px;">Salvar e Entrar</button>
                    </form>
                    <span class="auth-link" onclick="location.reload()">Voltar ao Login</span>
                </div>
            `;
        }

        async function confirmarNovaSenha(e, userId) {
            e.preventDefault();
            const nova = document.getElementById('novaSenha').value;
            const confirma = document.getElementById('confirmaSenha').value;

            if (nova !== confirma) {
                alert('As senhas n√£o coincidem!');
                return;
            }

            let users = [];
            if (USE_FIREBASE) {
                const usersData = await getData('system', 'users_list');
                users = usersData ? usersData.list : [];
            } else {
                users = JSON.parse(localStorage.getItem('app_users') || '[]');
            }

            const userIndex = users.findIndex(u => u.id === userId);
            
            if (userIndex >= 0) {
                users[userIndex].senha = nova;
                users[userIndex].mustChangePassword = false;
                
                if (USE_FIREBASE) {
                    await saveData('system', 'users_list', { list: users });
                } else {
                    localStorage.setItem('app_users', JSON.stringify(users));
                }
                
                currentUser = users[userIndex];
                carregarDadosUsuario();
                iniciarApp();
            } else {
                alert('Erro ao atualizar usu√°rio.');
                renderLogin();
            }
        }

        function logout() {
            currentUser = null;
            data = getInitialData(); // Limpa dados da mem√≥ria
            localStorage.removeItem('app_last_access');
            renderLogin();
        }

        async function carregarDadosUsuario() {
            if (!currentUser) return;
            
            let savedData = null;
            if (USE_FIREBASE) {
                savedData = JSON.stringify(await getData('app_data', getStorageKey())); // Convertendo para string para manter compatibilidade com JSON.parse abaixo
            } else {
                savedData = localStorage.getItem(getStorageKey());
            }

            if (savedData) {
                data = JSON.parse(savedData);
                // Garantir compatibilidade se novos campos forem adicionados no futuro
                const template = getInitialData();
                data = { ...template, ...data };
            } else {
                data = getInitialData();
            }
            
            // Se for a primeira carga ass√≠ncrona, precisamos re-renderizar a tela se o app j√° tiver iniciado
            if (document.getElementById('appContainer').style.display === 'block') {
                showScreen('dashboard'); // Refresh na tela atual
            }
        }

        async function persistirDados() {
            if (currentUser) {
                if (USE_FIREBASE) {
                    await saveData('app_data', getStorageKey(), data);
                } else {
                    localStorage.setItem(getStorageKey(), JSON.stringify(data));
                }
            }
        }

        function iniciarApp() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            document.getElementById('adminContainer').style.display = 'none';
            updateSession();
            
            // Carregar dados (pode ser ass√≠ncrono no Firebase)
            carregarDadosUsuario().then(() => {
                // Continua a inicializa√ß√£o ap√≥s carregar dados
                const today = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            
            let roleLabel = 'Painel do Professor';
            if (currentUser.role === 'gestor') roleLabel = 'Painel do Gestor';

            document.getElementById('currentDate').textContent = 
                `${today.toLocaleDateString('pt-BR', options)} | Ol√°, ${currentUser.nome}`;
            
            // Adicionar subt√≠tulo com o tipo de painel
            const header = document.querySelector('header');
            let subTitle = document.getElementById('painelSubtitle');
            if (!subTitle) {
                subTitle = document.createElement('div');
                subTitle.id = 'painelSubtitle';
                subTitle.style.fontSize = '16px';
                subTitle.style.marginTop = '5px';
                subTitle.style.fontWeight = 'bold';
                subTitle.style.color = '#a0aec0';
                header.appendChild(subTitle);
            }
            subTitle.textContent = roleLabel;

            sincronizarAgenda();
            
            if (currentUser.role === 'gestor') {
                renderGestorPanel();
            } else {
                renderProfessorPanel();
            }
            });
        }

        function renderProfessorPanel() {
            // Restaura navega√ß√£o de professor
            const nav = document.querySelector('nav');
            nav.innerHTML = `
                <button class="active" onclick="showScreen('dashboard', event)"><span class="icon">üìä</span><span class="label">Dashboard</span></button>
                <button onclick="showScreen('turmas', event)"><span class="icon">üë•</span><span class="label">Turmas</span></button>
                <button onclick="showScreen('tutoria', event)"><span class="icon">üéì</span><span class="label">Tutoria</span></button>
                <button onclick="showScreen('agenda', event)"><span class="icon">üìÖ</span><span class="label">Agenda</span></button>
            `;
            renderDashboard();
            showScreen('dashboard');
        }

        function renderGestorPanel() {
            // Navega√ß√£o de Gestor
            const nav = document.querySelector('nav');
            nav.innerHTML = `
                <button class="active" onclick="showScreen('dashboardGestor', event)"><span class="icon">üìä</span><span class="label">Dashboard Gest√£o</span></button>
                <button onclick="showScreen('turmas', event)"><span class="icon">üë•</span><span class="label">Turmas</span></button>
                <button onclick="showScreen('registrosGestor', event)"><span class="icon">üìÇ</span><span class="label">Registros</span></button>
                <button onclick="showScreen('ocorrenciasGestor', event)"><span class="icon">‚ö†Ô∏è</span><span class="label">Ocorr√™ncias</span></button>
                <button onclick="showScreen('horariosGestor', event)"><span class="icon">‚è∞</span><span class="label">Hor√°rios</span></button>
            `;
            
            // Criar telas do Gestor se n√£o existirem
            if (!document.getElementById('dashboardGestor')) {
                const container = document.getElementById('appContainer');
                
                // Dashboard Gestor
                const dash = document.createElement('div');
                dash.id = 'dashboardGestor';
                dash.className = 'screen';
                container.appendChild(dash);

                // Registros Gestor
                const reg = document.createElement('div');
                reg.id = 'registrosGestor';
                reg.className = 'screen';
                container.appendChild(reg);

                // Ocorr√™ncias Gestor
                const oco = document.createElement('div');
                oco.id = 'ocorrenciasGestor';
                oco.className = 'screen';
                container.appendChild(oco);

                // Hor√°rios Gestor
                const hor = document.createElement('div');
                hor.id = 'horariosGestor';
                hor.className = 'screen';
                container.appendChild(hor);
            }

            renderDashboardGestor();
            showScreen('dashboardGestor');
        }

        // NAVEGA√á√ÉO
        function showScreen(screenId, evt) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
            if (evt && evt.target) {
                evt.target.classList.add('active');
            } else {
                document.querySelectorAll('nav button').forEach(b => {
                    if (b.getAttribute('onclick') && b.getAttribute('onclick').includes(screenId)) {
                        b.classList.add('active');
                    }
                });
            }

            if (screenId === 'dashboard') renderDashboard();
            if (screenId === 'turmas') renderTurmas();
            if (screenId === 'tutoria') renderTutoria();
            if (screenId === 'agenda') renderAgenda();
            if (screenId === 'dashboardGestor') renderDashboard(); // Gestor usa mesma l√≥gica agora adaptada
            if (screenId === 'registrosGestor') renderRegistrosGestor();
            if (screenId === 'ocorrenciasGestor') renderOcorrenciasGestor();
            if (screenId === 'horariosGestor') renderHorariosGestor();
        }

        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
            
            if (modalId === 'modalNovoEncontro') {
                const select = document.getElementById('encontroTutorado');
                select.innerHTML = data.tutorados.map(t => 
                    `<option value="${t.id}">${t.nome_estudante}</option>`
                ).join('');
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // DASHBOARD
        function renderDashboard() {
            const today = getTodayString();
            const isGestor = currentUser && currentUser.role === 'gestor';
            
            // Aulas de hoje
            const aulasHoje = data.aulas.filter(a => a.data === today);
            const aulasHtml = aulasHoje.length > 0 ? aulasHoje.map(a => {
                const turma = data.turmas.find(t => t.id === a.id_turma);
                return `
                    <button class="btn btn-secondary" style="width: 100%; text-align: left; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; padding: 15px;" 
                         onclick="abrirTurma(${turma.id})"
                         onmouseover="this.style.transform='translateX(5px)'"
                         onmouseout="this.style.transform='translateX(0)'">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <span class="badge badge-info">Aula</span>
                                <strong>${turma.nome} - ${turma.disciplina}</strong> - ${a.conteudo}
                            </div>
                            <div style="font-size: 20px;">‚Üí</div>
                        </div>
                    </div>
                `;
            }).join('') : '<p class="empty-state">Nenhuma aula registrada para hoje</p>';
            
            document.getElementById('aulasHoje').innerHTML = aulasHtml;

            // Reuni√µes de Hoje
            const eventosHoje = data.eventos.filter(e => e.data === today && e.tipo !== 'Aula');
            const reunioesHtml = eventosHoje.length > 0 ? eventosHoje.map(e => `
                <div class="alert alert-warning" style="margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span class="badge badge-warning">${e.tipo}</span>
                            <strong>${e.hora_inicio}</strong> - ${e.descricao || e.tipo}
                        </div>
                    </div>
                </div>
            `).join('') : '<p class="empty-state">Nenhum evento extra hoje</p>';
            document.getElementById('reunioesHoje').innerHTML = reunioesHtml;

            // Tutorias de hoje
            const tutoriasHoje = data.encontros.filter(e => e.data === today);
            const tutoriasHtml = tutoriasHoje.length > 0 ? tutoriasHoje.map(e => {
                const tutorado = data.tutorados.find(t => t.id === e.id_tutorado);
                return `
                    <button class="btn btn-success" style="width: 100%; text-align: left; margin-bottom: 10px; background: #f0fdf4; color: #166534; border: 1px solid #22c55e;" 
                         onclick="irParaTutoria()"
                         onmouseover="this.style.transform='translateX(5px)'"
                         onmouseout="this.style.transform='translateX(0)'">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <span class="badge badge-success">Tutoria</span>
                                <strong>${tutorado.nome_estudante}</strong> - ${e.tema}
                            </div>
                            <div style="font-size: 20px;">‚Üí</div>
                        </div>
                    </div>
                `;
            }).join('') : '<p class="empty-state">Nenhuma tutoria para hoje</p>';
            
            // Se for gestor, mostrar bot√µes de a√ß√£o r√°pida no lugar de tutorias
            if (isGestor) {
                 document.getElementById('tutoriasHoje').innerHTML = `
                    <button class="btn btn-primary" onclick="abrirNovoRegistroGestao()" style="width: 100%; margin-bottom: 10px;">+ Novo Registro (Atestado/Falta)</button>
                    <button class="btn btn-secondary" onclick="showScreen('turmas')" style="width: 100%;">Gerenciar Turmas</button>
                 `;
            } else {
            document.getElementById('tutoriasHoje').innerHTML = tutoriasHtml;

            // Alertas
            let alertas = [];
            
            // Compensa√ß√µes pendentes
            const compPendentes = data.compensacoes.filter(c => c.status === 'pendente' && !c.arquivada);
            if (compPendentes.length > 0) {
                alertas.push(`
                    <div class="alert alert-warning">
                        <strong>${compPendentes.length}</strong> compensa√ß√£o(√µes) de falta pendente(s)
                    </div>
                `);
            }

            // Atrasos do dia
            const atrasosHoje = data.atrasos.filter(a => a.data === today);
            if (atrasosHoje.length > 0) {
                alertas.push(`
                    <div class="alert alert-warning">
                        <strong>${atrasosHoje.length}</strong> atraso(s) registrado(s) hoje
                    </div>
                `);
            }

            if (alertas.length === 0) {
                alertas.push('<div class="alert alert-success">Tudo em dia! ‚úì</div>');
            }

            document.getElementById('alertas').innerHTML = alertas.join('');
            }
        }

        function irParaTutoria() {
            showScreen('tutoria');
        }

        // TURMAS
        function renderTurmas() {
            const diasSemana = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
            const isGestor = currentUser && currentUser.role === 'gestor';
            
            const html = data.turmas.map(t => {
                const horarios = data.horariosAulas
                    .filter(h => h.id_turma === t.id)
                    .sort((a, b) => a.dia_semana - b.dia_semana || a.hora_inicio.localeCompare(b.hora_inicio));
                
                const horariosHtml = horarios.length > 0 
                    ? `<div style="margin-top: 10px; font-size: 12px; color: #4a5568; background: #edf2f7; padding: 8px; border-radius: 4px;">
                        ${horarios.map(h => `<div>üìÖ ${diasSemana[h.dia_semana]} ‚Ä¢ ‚è∞ ${h.hora_inicio} - ${h.hora_fim}</div>`).join('')}
                       </div>`
                    : '<div style="margin-top: 10px; font-size: 12px; color: #a0aec0; font-style: italic;">Sem hor√°rios configurados</div>';

                return `
                <div class="class-item" onclick="abrirTurma(${t.id})" style="position: relative;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <h3>${t.ano_serie} ${t.disciplina ? '- ' + t.disciplina : ''}</h3>
                            <div class="class-info">
                                ${t.ano_serie} ‚Ä¢ ${t.turno}
                            </div>
                        </div>
                        <div onclick="event.stopPropagation()" style="${isGestor ? '' : 'display:none;'}">
                            <button class="btn btn-sm btn-secondary" onclick="editarTurma(${t.id})" title="Editar">‚úèÔ∏è</button>
                            <button class="btn btn-sm btn-danger" onclick="removerTurma(${t.id})" title="Excluir">üóëÔ∏è</button>
                        </div>
                    </div>
                    ${horariosHtml}
                </div>
            `}).join('');

            document.getElementById('listaTurmas').innerHTML = html || '<p class="empty-state">Nenhuma turma cadastrada</p>';
        }

        // Fun√ß√£o auxiliar para buscar turmas criadas por gestores (simula√ß√£o)
        function getTurmasGestao() {
            const schoolId = (currentUser && currentUser.schoolId) || 'default';
            const gestorData = JSON.parse(localStorage.getItem('app_data_school_' + schoolId + '_gestor') || '{}');
            return gestorData.turmas || [];
        }

        function abrirModalNovaTurma() {
            document.getElementById('turmaId').value = '';
            document.getElementById('turmaAno').value = '';
            document.getElementById('turmaDisciplina').value = '';
            document.getElementById('turmaTurno').value = '';
            
            // Gestor n√£o define disciplina
            const isGestor = currentUser && currentUser.role === 'gestor';
            document.getElementById('divTurmaDisciplina').style.display = isGestor ? 'none' : 'block';
            if (isGestor) document.getElementById('turmaDisciplina').removeAttribute('required');
            else document.getElementById('turmaDisciplina').setAttribute('required', 'true');

            // L√≥gica do Select para Professor
            if (!isGestor) {
                document.getElementById('containerTurmaAnoInput').style.display = 'none';
                document.getElementById('containerTurmaAnoSelect').style.display = 'block';
                document.getElementById('turmaAno').removeAttribute('required');
                
                const turmasGestao = getTurmasGestao();
                const select = document.getElementById('turmaAnoSelect');
                select.innerHTML = '<option value="">Selecione a Turma...</option>' + 
                    turmasGestao.map(t => `<option value="${t.nome}">${t.nome} (${t.turno})</option>`).join('');
            } else {
                document.getElementById('containerTurmaAnoInput').style.display = 'block';
                document.getElementById('containerTurmaAnoSelect').style.display = 'none';
                document.getElementById('turmaAno').setAttribute('required', 'true');
            }

            document.getElementById('tituloModalTurma').textContent = 'Nova Turma';
            showModal('modalNovaTurma');
        }

        function editarTurma(id) {
            const turma = data.turmas.find(t => t.id === id);
            if (!turma) return;

            const isGestor = currentUser && currentUser.role === 'gestor';
            document.getElementById('divTurmaDisciplina').style.display = isGestor ? 'none' : 'block';
            if (isGestor) document.getElementById('turmaDisciplina').removeAttribute('required');
            else document.getElementById('turmaDisciplina').setAttribute('required', 'true');

            // Na edi√ß√£o, volta para input normal para simplificar
            document.getElementById('containerTurmaAnoInput').style.display = 'block';
            document.getElementById('containerTurmaAnoSelect').style.display = 'none';

            document.getElementById('turmaId').value = turma.id;
            document.getElementById('turmaAno').value = turma.ano_serie;
            document.getElementById('turmaDisciplina').value = turma.disciplina || '';
            document.getElementById('turmaTurno').value = turma.turno;
            
            document.getElementById('tituloModalTurma').textContent = 'Editar Turma';
            showModal('modalNovaTurma');
        }

        function salvarTurma(e) {
            e.preventDefault();
            
            const id = document.getElementById('turmaId').value;
            let ano = document.getElementById('turmaAno').value;
            
            const isGestor = currentUser && currentUser.role === 'gestor';
            if (!isGestor && !id) {
                ano = document.getElementById('turmaAnoSelect').value;
            }

            const disciplina = document.getElementById('turmaDisciplina').value;
            const turno = document.getElementById('turmaTurno').value;

            if (id) {
                const turma = data.turmas.find(t => t.id == id);
                if (turma) {
                    turma.nome = ano; // Mantendo compatibilidade, nome agora √© igual ano/serie
                    turma.ano_serie = ano;
                    turma.disciplina = disciplina;
                    turma.turno = turno;
                }
            } else {
                data.turmas.push({
                    id: getNextId(data.turmas),
                    nome: ano,
                    ano_serie: ano,
                    disciplina: disciplina,
                    turno: turno
                });
            }
            
            persistirDados();
            closeModal('modalNovaTurma');
            renderTurmas();
            e.target.reset();
        }

        function removerTurma(id) {
            if (confirm('Tem certeza que deseja excluir esta turma?')) {
                data.turmas = data.turmas.filter(t => t.id !== id);
                persistirDados();
                renderTurmas();
            }
        }

        function abrirTurma(id) {
            turmaAtual = id;
            const turma = data.turmas.find(t => t.id === id);
            const isGestor = currentUser && currentUser.role === 'gestor';
            
            document.getElementById('turmaDetalheTitulo').textContent = `${turma.ano_serie} ${turma.disciplina ? '- ' + turma.disciplina : ''}`;
            
            const estudantes = data.estudantes.filter(e => e.id_turma === id);
            const stats = `
                <div class="stat-item">
                    <div class="stat-value">${estudantes.length}</div>
                    <div class="stat-label">Estudantes</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${data.trabalhos.filter(t => t.id_turma === id).length}</div>
                    <div class="stat-label">Trabalhos</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${data.aulas.filter(a => a.id_turma === id).length}</div>
                    <div class="stat-label">Aulas</div>
                </div>
            `;
            document.getElementById('turmaStats').innerHTML = stats;
            
            showScreen('turmaDetalhe');
            
            // Ajustar tabs para Gestor
            const nav = document.querySelector('#turmaDetalhe nav');
            if (isGestor) {
                nav.innerHTML = `
                    <button class="btn btn-secondary active" onclick="showTurmaTab('estudantes', event)"><span class="icon">üë•</span><span class="label">Estudantes</span></button>
                `;
            } else {
                nav.innerHTML = `
                    <button class="btn btn-secondary active" onclick="showTurmaTab('estudantes', event)"><span class="icon">üë•</span><span class="label">Estudantes</span></button>
                    <button class="btn btn-secondary" onclick="showTurmaTab('chamada', event)"><span class="icon">üìù</span><span class="label">Chamada</span></button>
                    <button class="btn btn-secondary" onclick="showTurmaTab('atrasos', event)"><span class="icon">‚è∞</span><span class="label">Atrasos</span></button>
                    <button class="btn btn-secondary" onclick="showTurmaTab('trabalhos', event)"><span class="icon">üìö</span><span class="label">Trabalhos</span></button>
                    <button class="btn btn-secondary" onclick="showTurmaTab('ocorrencias', event)"><span class="icon">‚ö†Ô∏è</span><span class="label">Ocorr√™ncias</span></button>
                `;
            }

            showTurmaTab('estudantes');
        }

        function showTurmaTab(tabName, evt) {
            const navButtons = document.querySelectorAll('#turmaDetalhe nav button');
            navButtons.forEach(b => b.classList.remove('active'));
            
            if (evt && evt.currentTarget) {
                evt.currentTarget.classList.add('active');
            } else {
                const btn = Array.from(navButtons).find(b => b.getAttribute('onclick').includes(`'${tabName}'`));
                if (btn) btn.classList.add('active');
            }

            document.querySelectorAll('.turma-tab').forEach(t => {
                t.classList.remove('active');
                t.style.display = 'none';
            });
            
            const tabElement = document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1));
            if (tabElement) {
                tabElement.classList.add('active');
                tabElement.style.display = 'block';
            }

            if (tabName === 'estudantes') renderEstudantes();
            if (tabName === 'chamada') renderChamada();
            if (tabName === 'atrasos') renderAtrasos();
            if (tabName === 'trabalhos') renderTrabalhos();
            if (tabName === 'compensacoes') renderCompensacoes();
            if (tabName === 'mapeamento') renderMapeamento();
            if (tabName === 'ocorrencias') renderOcorrencias();
        }

        // ESTUDANTES
        function renderEstudantes() {
            const estudantes = getEstudantesDaTurma(turmaAtual).sort((a, b) => a.numero_chamada - b.numero_chamada);
            
            const isGestor = currentUser && currentUser.role === 'gestor';

            const html = `
                <div style="display: flex; gap: 10px; margin-bottom: 15px; ${!isGestor ? 'display:none;' : ''}">
                    <button class="btn btn-primary" onclick="showModal('modalNovoEstudante')">+ Adicionar Estudante</button>
                    ${isGestor ? `
                        <button class="btn btn-success" onclick="showModal('modalImportarEstudantes')">üìã Importar/Atualizar CSV</button>
                        <div style="font-size: 11px; color: #718096; align-self: center;">
                            *Upload CSV atualiza turmas se o aluno j√° existir.
                        </div>
                    ` : ``}
                </div>
                ${estudantes.length > 0 ? `
                    <div class="import-info">
                        ‚úì ${estudantes.length} estudante(s) cadastrado(s) nesta turma
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>N¬∫</th>
                                <th>Nome Completo</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${estudantes.map(e => `
                                <tr>
                                    <td>${e.numero_chamada}</td>
                                    <td>${e.nome_completo}</td>
                                    <td>
                                        <select onchange="atualizarStatusEstudante(${e.id}, this.value)" class="status-select" style="font-size: 12px; padding: 4px; width: auto;">
                                            <option value="Ativo" ${!e.status || e.status === 'Ativo' ? 'selected' : ''}>Ativo</option>
                                            <option value="Baixa/Transfer√™ncia" ${e.status === 'Baixa/Transfer√™ncia' ? 'selected' : ''}>Baixa/Transfer√™ncia</option>
                                            <option value="Transferido" ${e.status === 'Transferido' ? 'selected' : ''}>Transferido</option>
                                            <option value="NCOM" ${e.status === 'NCOM' ? 'selected' : ''}>NCOM</option>
                                        </select>
                                    </td>
                                    <td>
                                        <button class="btn btn-info btn-sm" onclick="abrirVisaoGeralEstudante(${e.id})" title="Vis√£o Geral">üëÅÔ∏è</button> 
                                        ${isGestor ? `<button class="btn btn-danger btn-sm" onclick="removerEstudante(${e.id})" title="Remover">üóëÔ∏è</button>` : ''}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                ` : '<p class="empty-state">Nenhum estudante cadastrado. ' + (isGestor ? 'Use os bot√µes acima para adicionar.' : 'Contate a gest√£o.') + '</p>'}
            `;

            document.getElementById('tabEstudantes').innerHTML = html;
        }

        function salvarEstudante(e) {
            e.preventDefault();
            
            const nome = document.getElementById('estudanteNome').value;
            const status = document.getElementById('estudanteStatus').value;

            // Verificar duplicatas
            const existe = getEstudantesDaTurma(turmaAtual).find(est => 
                est.id_turma === turmaAtual && est.nome_completo === nome
            );

            if (existe) {
                alert('J√° existe um estudante com este nome nesta turma!');
                return;
            }

            const estudantesTurma = getEstudantesDaTurma(turmaAtual);
            const numero = estudantesTurma.length > 0 ? Math.max(...estudantesTurma.map(e => e.numero_chamada)) + 1 : 1;

            const novoEstudante = {
                id: getNextId(data.estudantes),
                id_turma: turmaAtual,
                nome_completo: nome,
                numero_chamada: numero,
                status: status
            };

            data.estudantes.push(novoEstudante);
            persistirDados();
            closeModal('modalNovoEstudante');
            renderEstudantes();
            e.target.reset();
        }

        function removerEstudante(id) {
            if (confirm('Deseja realmente remover este estudante?')) {
                data.estudantes = data.estudantes.filter(e => e.id !== id);
                persistirDados();
                renderEstudantes();
            }
        }

        function atualizarStatusEstudante(id, novoStatus) {
            const estudante = getEstudanteById(id);
            if (estudante) {
                estudante.status = novoStatus;
                persistirDados();
            }
        }

        function importarEstudantes(e) {
            e.preventDefault();
            
            const isGestor = currentUser && currentUser.role === 'gestor';
            const fileInput = document.getElementById('arquivoEstudantes');
            const file = fileInput.files[0];

            if (!file) {
                alert('Selecione um arquivo CSV.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                const texto = event.target.result;
                const linhas = texto.split('\n').filter(l => l.trim() !== '');
                processarImportacao(linhas, isGestor);
            };
            reader.readAsText(file);
        }

        function processarImportacao(linhas, isGestor) {
            const estudantesAtuais = data.estudantes.filter(e => e.id_turma === turmaAtual);
            let proximoNumero = estudantesAtuais.length > 0 
                ? Math.max(...estudantesAtuais.map(e => e.numero_chamada)) + 1 
                : 1;

            let importados = 0;
            let duplicados = 0;
            let movidos = 0;

            linhas.forEach(linha => {
                const partes = linha.split(';');
                const nomeCompleto = partes[0].trim();
                const status = partes[1] ? partes[1].trim() : 'Ativo';
                
                if (!nomeCompleto) return;

                // Ignorar cabe√ßalhos do arquivo de exporta√ß√£o
                if (nomeCompleto === 'Alunos' || 
                    nomeCompleto === 'Filtros' || 
                    nomeCompleto === 'Ano Letivo' || 
                    nomeCompleto === 'Nome do Aluno') {
                    return;
                }

                // Verificar duplicatas
                let existe = null;
                if (isGestor) {
                    existe = data.estudantes.find(e => e.nome_completo.toLowerCase() === nomeCompleto.toLowerCase());
                } else {
                    existe = data.estudantes.find(e => e.id_turma === turmaAtual && e.nome_completo.toLowerCase() === nomeCompleto.toLowerCase());
                }

                if (existe && isGestor && existe.id_turma !== turmaAtual) {
                    // Mover estudante
                    existe.id_turma = turmaAtual;
                    existe.numero_chamada = proximoNumero++;
                    existe.status = status;
                    movidos++;
                } else if (!existe) {
                    data.estudantes.push({
                        id: getNextId(data.estudantes),
                        id_turma: turmaAtual,
                        nome_completo: nomeCompleto,
                        numero_chamada: proximoNumero,
                        status: status
                    });
                    proximoNumero++;
                    importados++;
                } else if (existe) {
                    duplicados++;
                }
            });

            persistirDados();
            closeModal('modalImportarEstudantes');
            renderEstudantes();
            document.getElementById('arquivoEstudantes').value = ''; // Limpar input

            let mensagem = `${importados} estudante(s) importado(s) com sucesso!`;
            if (duplicados > 0) {
                mensagem += `\n${duplicados} nome(s) duplicado(s) foram ignorados.`;
            }
            if (movidos > 0) {
                mensagem += `\n${movidos} estudante(s) movido(s) de outras turmas.`;
            }
            alert(mensagem);
        }

        /* 
        // ANTIGA FUN√á√ÉO DE IMPORTA√á√ÉO (REMOVIDA/SUBSTITU√çDA)
        function importarEstudantes(e) {
            // ... (c√≥digo antigo removido para usar FileReader)
        }
        */

        // CHAMADA
        function renderChamada() {
            const estudantes = getEstudantesDaTurma(turmaAtual).sort((a, b) => a.numero_chamada - b.numero_chamada);

            const html = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 8px; margin-bottom: 25px;">
                    <h3 style="color: white; margin: 0 0 10px 0; border: none; padding: 0;">üìã Registro de Presen√ßa</h3>
                    <p style="margin: 0; font-size: 14px; opacity: 0.95;">
                        Selecione a data e hor√°rio da aula para registrar a presen√ßa dos estudantes
                    </p>
                </div>

                <div style="background: #f7fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #e2e8f0;">
                    <div class="form-row">
                        <label>
                            üìÖ Data da Aula:
                            <input type="date" id="chamadaData" value="${getTodayString()}" onchange="carregarChamada()">
                        </label>
                        <label>
                            ‚è∞ Hor√°rio da Aula:
                            <select id="chamadaHorario" onchange="carregarChamada()">
                                <option value="">Selecione o hor√°rio...</option>
                                ${gerarOpcoesHorarios()}
                            </select>
                        </label>
                    </div>
                    <div id="conteudoAulaDiv" style="display:none; margin-top: 15px;">
                        <label>
                            üìù Conte√∫do da Aula:
                            <input type="text" id="conteudoAulaInput" placeholder="Digite o conte√∫do ministrado nesta aula...">
                        </label>
                    </div>
                </div>

                <div id="listaChamada"></div>
            `;

            document.getElementById('tabChamada').innerHTML = html;
            carregarChamada();
        }

        function gerarOpcoesHorarios() {
            const horarios = data.horariosAulas.filter(h => h.id_turma === turmaAtual);
            const diasSemana = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
            
            if (horarios.length === 0) {
                return '<option value="">Configure os hor√°rios na aba Configura√ß√µes</option>';
            }

            return horarios.map(h => {
                const dia = diasSemana[h.dia_semana];
                return `<option value="${h.id}">${dia} ${h.hora_inicio}-${h.hora_fim}</option>`;
            }).join('');
        }

        function carregarChamada() {
            const data_selecionada = document.getElementById('chamadaData')?.value;
            const horario_id = document.getElementById('chamadaHorario')?.value;

            if (!data_selecionada || !horario_id) {
                document.getElementById('listaChamada').innerHTML = '<p class="empty-state">Selecione a data e o hor√°rio da aula acima</p>';
                return;
            }

            const horario = data.horariosAulas.find(h => h.id == horario_id);
            const estudantes = getEstudantesDaTurma(turmaAtual).filter(e => !e.status || e.status === 'Ativo')
                .sort((a, b) => a.numero_chamada - b.numero_chamada);

            // Buscar ou criar aula
            let aula = data.aulas.find(a => 
                a.id_turma === turmaAtual && 
                a.data === data_selecionada && 
                a.horario_id == horario_id
            );

            if (!aula) {
                aula = {
                    id: getNextId(data.aulas),
                    id_turma: turmaAtual,
                    data: data_selecionada,
                    horario_id: parseInt(horario_id),
                    conteudo: '',
                    chamada_realizada: false
                };
                data.aulas.push(aula);
                persistirDados();
            }

            // Mostrar campo de conte√∫do
            const conteudoDiv = document.getElementById('conteudoAulaDiv');
            if (conteudoDiv) {
                conteudoDiv.style.display = 'block';
                const conteudoInput = document.getElementById('conteudoAulaInput');
                if (conteudoInput) {
                    conteudoInput.value = aula.conteudo || '';
                    conteudoInput.onchange = function() {
                        aula.conteudo = this.value;
                        persistirDados();
                    };
                }
            }

            const html = `
                <h4>‚úì Registrar Presen√ßa - ${formatDate(data_selecionada)} (${horario.hora_inicio}-${horario.hora_fim})</h4>
                <table>
                    <thead>
                        <tr>
                            <th>N¬∫</th>
                            <th>Nome</th>
                            <th style="text-align: center;">Presente</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${estudantes.map(e => {
                            const presenca = data.presencas.find(p => 
                                p.id_aula === aula.id && p.id_estudante === e.id
                            );
                            const presente = presenca ? presenca.status === 'presente' : true;

                            return `
                                <tr>
                                    <td>${e.numero_chamada}</td>
                                    <td>${e.nome_completo}</td>
                                    <td style="text-align: center;">
                                        <input type="checkbox" ${presente ? 'checked' : ''} 
                                               onchange="marcarPresenca(${aula.id}, ${e.id}, this.checked)"
                                               style="width: 20px; height: 20px; cursor: pointer;">
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
                <div style="margin-top: 20px; display: flex; justify-content: flex-end;">
                    <button class="btn btn-success" onclick="salvarChamadaManual(${aula.id})">üíæ Salvar Chamada</button>
                </div>
            `;

            document.getElementById('listaChamada').innerHTML = html;
        }

        function salvarChamadaManual(aulaId) {
            const aula = data.aulas.find(a => a.id === aulaId);
            if (aula) {
                aula.chamada_realizada = true;
                alert('Chamada salva e confirmada com sucesso!');
                persistirDados();
                // Atualiza a visualiza√ß√£o se necess√°rio
                carregarChamada();
            }
        }

        function marcarPresenca(aulaId, estudanteId, presente) {
            let presenca = data.presencas.find(p => 
                p.id_aula === aulaId && p.id_estudante === estudanteId
            );

            if (!presenca) {
                presenca = {
                    id: getNextId(data.presencas),
                    id_aula: aulaId,
                    id_estudante: estudanteId,
                    status: presente ? 'presente' : 'falta'
                };
                data.presencas.push(presenca);
            } else {
                presenca.status = presente ? 'presente' : 'falta';
            }
            persistirDados();
        }

        // ATRASOS
        function renderAtrasos() {
            const estudantes = getEstudantesDaTurma(turmaAtual).filter(e => !e.status || e.status === 'Ativo')
                .sort((a, b) => a.numero_chamada - b.numero_chamada);

            const estudantesComAtraso = estudantes.filter(e => {
                const total = data.atrasos.filter(a => a.id_estudante === e.id).length;
                return total > 0;
            });

            const html = `
                <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 25px; border-radius: 8px; margin-bottom: 25px;">
                    <h3 style="color: white; margin: 0 0 10px 0; border: none; padding: 0;">‚è∞ Registro de Atrasos</h3>
                    <p style="margin: 0; font-size: 14px; opacity: 0.95;">
                        Selecione a data, hor√°rio e o estudante para registrar o atraso
                    </p>
                </div>

                <div style="background: #f7fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #e2e8f0;">
                    <div class="form-row">
                        <label>
                            üìÖ Data da Aula:
                            <input type="date" id="atrasoData" value="${getTodayString()}" onchange="carregarAtrasos()">
                        </label>
                        <label>
                            ‚è∞ Hor√°rio da Aula:
                            <select id="atrasoHorario" onchange="carregarAtrasos()">
                                <option value="">Selecione o hor√°rio...</option>
                                ${gerarOpcoesHorarios()}
                            </select>
                        </label>
                    </div>
                    <div id="formAdicionarAtraso" style="display:none; margin-top: 15px; border-top: 1px solid #e2e8f0; padding-top: 15px;">
                        <label>
                            üë§ Estudante:
                            <div style="display: flex; gap: 10px;">
                                <select id="atrasoEstudanteSelect" style="flex: 1;">
                                    <option value="">Selecione o estudante...</option>
                                    ${estudantes.map(e => `<option value="${e.id}">${e.numero_chamada} - ${e.nome_completo}</option>`).join('')}
                                </select>
                                <button class="btn btn-primary" onclick="adicionarAtrasoManual()">+ Adicionar</button>
                            </div>
                        </label>
                    </div>
                </div>

                <div id="listaAtrasosAula"></div>

                <div style="margin-top: 30px;">
                    <h4>üìä Resumo Geral de Atrasos (Apenas com registros)</h4>
                    <div id="resumoGeralAtrasos">
                        ${estudantesComAtraso.length > 0 ? `
                            <table>
                                <thead>
                                    <tr>
                                        <th>N¬∫</th>
                                        <th>Estudante</th>
                                        <th>Total de Atrasos</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${estudantesComAtraso.map(e => {
                                        const totalAtrasos = data.atrasos.filter(a => a.id_estudante === e.id).length;
                                        return `
                                            <tr>
                                                <td>${e.numero_chamada}</td>
                                                <td>${e.nome_completo}</td>
                                                <td><span class="badge badge-warning">${totalAtrasos} atraso(s)</span></td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        ` : '<p class="empty-state">Nenhum atraso registrado nesta turma.</p>'}
                    </div>
                </div>
            `;

            document.getElementById('tabAtrasos').innerHTML = html;
            carregarAtrasos();
        }

        function carregarAtrasos() {
            const data_selecionada = document.getElementById('atrasoData')?.value;
            const horario_id = document.getElementById('atrasoHorario')?.value;
            const formDiv = document.getElementById('formAdicionarAtraso');
            const listaDiv = document.getElementById('listaAtrasosAula');

            if (!data_selecionada || !horario_id) {
                if (listaDiv) listaDiv.innerHTML = '<p class="empty-state">Selecione a data e o hor√°rio da aula acima</p>';
                if (formDiv) formDiv.style.display = 'none';
                return;
            }

            if (formDiv) formDiv.style.display = 'block';

            const horario = data.horariosAulas.find(h => h.id == horario_id);

            // Buscar aula
            let aula = data.aulas.find(a => 
                a.id_turma === turmaAtual && 
                a.data === data_selecionada && 
                a.horario_id == horario_id
            );

            if (!aula) {
                aula = {
                    id: getNextId(data.aulas),
                    id_turma: turmaAtual,
                    data: data_selecionada,
                    horario_id: parseInt(horario_id),
                    conteudo: ''
                };
                data.aulas.push(aula);
                persistirDados();
            }

            // Get delays for this class
            const atrasosNestaAula = data.atrasos.filter(a => a.id_aula === aula.id);

            const html = `
                <h4>‚è∞ Atrasos Registrados nesta Aula (${atrasosNestaAula.length})</h4>
                ${atrasosNestaAula.length > 0 ? `
                    <table>
                        <thead>
                            <tr>
                                <th>N¬∫</th>
                                <th>Nome</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${atrasosNestaAula.map(a => {
                                const est = getEstudanteById(a.id_estudante);
                                return `
                                    <tr>
                                        <td>${est.numero_chamada}</td>
                                        <td>${est.nome_completo}</td>
                                        <td>
                                            <button class="btn btn-danger btn-sm" onclick="removerAtraso(${a.id})">üóëÔ∏è Remover</button>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                ` : '<p class="empty-state" style="font-size: 13px;">Nenhum atraso registrado para esta aula.</p>'}
            `;

            if (listaDiv) listaDiv.innerHTML = html;
        }

        function adicionarAtrasoManual() {
            const data_selecionada = document.getElementById('atrasoData').value;
            const horario_id = document.getElementById('atrasoHorario').value;
            const estudanteId = parseInt(document.getElementById('atrasoEstudanteSelect').value);

            if (!estudanteId) {
                alert('Selecione um estudante.');
                return;
            }

            let aula = data.aulas.find(a => 
                a.id_turma === turmaAtual && 
                a.data === data_selecionada && 
                a.horario_id == parseInt(horario_id)
            );

            if (!aula) {
                aula = {
                    id: getNextId(data.aulas),
                    id_turma: turmaAtual,
                    data: data_selecionada,
                    horario_id: parseInt(horario_id),
                    conteudo: ''
                };
                data.aulas.push(aula);
            }

            const existe = data.atrasos.find(a => a.id_aula === aula.id && a.id_estudante === estudanteId);
            if (existe) {
                alert('Este estudante j√° est√° registrado com atraso nesta aula.');
                return;
            }

            data.atrasos.push({
                id: getNextId(data.atrasos),
                id_estudante: estudanteId,
                id_aula: aula.id,
                data: aula.data
            });

            persistirDados();
            document.getElementById('atrasoEstudanteSelect').value = "";
            carregarAtrasos();
            atualizarResumoAtrasos();
        }

        function removerAtraso(id) {
            if (confirm('Remover este atraso?')) {
                data.atrasos = data.atrasos.filter(a => a.id !== id);
                persistirDados();
                carregarAtrasos();
                atualizarResumoAtrasos();
            }
        }

        function atualizarResumoAtrasos() {
            const estudantes = getEstudantesDaTurma(turmaAtual).filter(e => !e.status || e.status === 'Ativo')
                .sort((a, b) => a.numero_chamada - b.numero_chamada);

            const estudantesComAtraso = estudantes.filter(e => {
                const total = data.atrasos.filter(a => a.id_estudante === e.id).length;
                return total > 0;
            });

            const html = estudantesComAtraso.length > 0 ? `
                <table>
                    <thead>
                        <tr>
                            <th>N¬∫</th>
                            <th>Estudante</th>
                            <th>Total de Atrasos</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${estudantesComAtraso.map(e => {
                            const totalAtrasos = data.atrasos.filter(a => a.id_estudante === e.id).length;
                            return `
                                <tr>
                                    <td>${e.numero_chamada}</td>
                                    <td>${e.nome_completo}</td>
                                    <td><span class="badge badge-warning">${totalAtrasos} atraso(s)</span></td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            ` : '<p class="empty-state">Nenhum atraso registrado nesta turma.</p>';

            const container = document.getElementById('resumoGeralAtrasos');
            if (container) container.innerHTML = html;
        }

        // TRABALHOS
        function renderTrabalhos() {
            const trabalhos = data.trabalhos.filter(t => t.id_turma === turmaAtual);

            const html = `
                <button class="btn btn-primary" onclick="showModal('modalNovoTrabalho')">+ Novo Trabalho</button>
                ${trabalhos.length > 0 ? `
                    <table>
                        <thead>
                            <tr>
                                <th>T√≠tulo</th>
                                <th>Peso</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${trabalhos.map(t => `
                                <tr>
                                    <td>${t.titulo}</td>
                                    <td>${t.peso}</td>
                                    <td>
                                        <button class="btn btn-secondary" onclick="lancarNotas(${t.id})">Lan√ßar Notas</button>
                                        <button class="btn btn-danger btn-sm" onclick="removerTrabalho(${t.id})">üóëÔ∏è</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                ` : '<p class="empty-state">Nenhum trabalho cadastrado</p>'}
            `;

            document.getElementById('tabTrabalhos').innerHTML = html;
        }

        function salvarTrabalho(e) {
            e.preventDefault();

            const novoTrabalho = {
                id: getNextId(data.trabalhos),
                id_turma: turmaAtual,
                titulo: document.getElementById('trabalhoTitulo').value,
                peso: parseFloat(document.getElementById('trabalhoPeso').value)
            };

            data.trabalhos.push(novoTrabalho);
            persistirDados();
            closeModal('modalNovoTrabalho');
            renderTrabalhos();
            e.target.reset();
        }

        function removerTrabalho(id) {
            if (confirm('Deseja remover este trabalho?')) {
                data.trabalhos = data.trabalhos.filter(t => t.id !== id);
                persistirDados();
                renderTrabalhos();
            }
        }

        function lancarNotas(trabalhoId) {
            const trabalho = data.trabalhos.find(t => t.id === trabalhoId);
            const estudantes = getEstudantesDaTurma(turmaAtual).filter(e => !e.status || e.status === 'Ativo')
                .sort((a, b) => a.numero_chamada - b.numero_chamada);

            let html = `
                <h3>${trabalho.titulo} (Peso: ${trabalho.peso})</h3>
                <table style="width: 100%; margin-top: 20px;">
                    <thead>
                        <tr>
                            <th>N¬∫</th>
                            <th>Estudante</th>
                            <th>Nota (0-10)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            estudantes.forEach(e => {
                const notaExistente = data.notas.find(n => n.id_estudante === e.id && n.id_trabalho === trabalhoId);
                html += `
                    <tr>
                        <td>${e.numero_chamada}</td>
                        <td>${e.nome_completo}</td>
                        <td>
                            <input type="number" min="0" max="10" step="0.1" 
                                   value="${notaExistente ? notaExistente.valor : ''}"
                                   data-estudante="${e.id}"
                                   style="width: 80px; padding: 5px;"
                                   placeholder="0.0">
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="salvarNotas(${trabalhoId})">Salvar Notas</button>
                    <button class="btn btn-secondary" onclick="closeModal('modalLancarNotas')">Cancelar</button>
                </div>
            `;

            document.getElementById('conteudoLancarNotas').innerHTML = html;
            showModal('modalLancarNotas');
        }

        function salvarNotas(trabalhoId) {
            const inputs = document.querySelectorAll('#modalLancarNotas input[type="number"]');
            let salvas = 0;
            
            inputs.forEach(input => {
                const estudanteId = parseInt(input.getAttribute('data-estudante'));
                const valor = parseFloat(input.value);
                
                if (!isNaN(valor)) {
                    let nota = data.notas.find(n => n.id_estudante === estudanteId && n.id_trabalho === trabalhoId);
                    
                    if (nota) {
                        nota.valor = valor;
                    } else {
                        data.notas.push({
                            id: getNextId(data.notas),
                            id_estudante: estudanteId,
                            id_trabalho: trabalhoId,
                            valor: valor
                        });
                    }
                    salvas++;
                }
            });
            
            persistirDados();
            alert(`${salvas} nota(s) salva(s) com sucesso!`);
            closeModal('modalLancarNotas');
        }

        // COMPENSA√á√ïES
        function renderCompensacoes() {
            const html = `
                <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; padding: 25px; border-radius: 8px; margin-bottom: 25px;">
                    <h3 style="color: white; margin: 0 0 10px 0; border: none; padding: 0;">üìù Compensa√ß√£o de Aus√™ncias</h3>
                    <p style="margin: 0; font-size: 14px; opacity: 0.95;">
                        Crie trabalhos de compensa√ß√£o e atribua aos estudantes com faltas
                    </p>
                </div>

                <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="mostrarNovaCompensacao()">+ Nova Compensa√ß√£o</button>
                    <button class="btn btn-secondary" onclick="mostrarListaCompensacoes()">üìã Ver Todas</button>
                </div>

                <div id="areaNovaCompensacao" style="display:none;"></div>
                <div id="areaListaCompensacoes"></div>
            `;

            document.getElementById('tabCompensacoes').innerHTML = html;
            mostrarListaCompensacoes();
        }

        let filtroCompensacoes = 'ativas';
        let filtroDataInicio = '';
        let filtroDataFim = '';

        function mostrarNovaCompensacao() {
            const html = `
                <div style="background: #f7fafc; padding: 25px; border-radius: 8px; border: 2px solid #e2e8f0; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h4 style="margin: 0;">üìã Nova Compensa√ß√£o</h4>
                        <button class="btn btn-secondary" onclick="ocultarNovaCompensacao()">‚úï Fechar</button>
                    </div>

                    <div style="background: #fff3cd; padding: 15px; border-radius: 6px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                        <strong>üìå Como funciona:</strong>
                        <ol style="margin: 10px 0 0 20px; padding: 0; font-size: 14px;">
                            <li>Defina o per√≠odo para calcular as faltas</li>
                            <li>Descreva o trabalho de compensa√ß√£o</li>
                            <li>Selecione quais estudantes receber√£o este trabalho</li>
                            <li>Depois, controle o status individual de cada um</li>
                        </ol>
                    </div>

                    <h4>1Ô∏è‚É£ Per√≠odo de Refer√™ncia</h4>
                    <div class="form-row">
                        <label>
                            üìÖ Data In√≠cio:
                            <input type="date" id="novaCompPeriodoInicio" onchange="calcularFaltasNova()">
                        </label>
                        <label>
                            üìÖ Data Fim:
                            <input type="date" id="novaCompPeriodoFim" onchange="calcularFaltasNova()">
                        </label>
                    </div>

                    <div id="faltasCalculadas" style="margin: 20px 0;"></div>

                    <div id="formNovaComp" style="display:none;">
                        <h4>2Ô∏è‚É£ Descri√ß√£o da Compensa√ß√£o</h4>
                        <label>
                            üìù Descri√ß√£o do Trabalho:
                            <textarea id="novaCompDescricao" rows="3" placeholder="Ex: Resumo sobre Equa√ß√µes do 2¬∫ Grau (m√≠nimo 2 p√°ginas) + Lista de 20 exerc√≠cios resolvidos" required></textarea>
                        </label>

                        <div class="form-row">
                            <label>
                                üìÖ Prazo de Entrega:
                                <input type="date" id="novaCompDataEntrega" required>
                            </label>
                        </div>

                        <h4>3Ô∏è‚É£ Selecione os Estudantes</h4>
                        <div style="background: white; padding: 15px; border-radius: 6px; border: 2px solid #e2e8f0; max-height: 300px; overflow-y: auto;">
                            <div style="margin-bottom: 10px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" onchange="selecionarTodosEstudantes(this.checked)" style="width: 18px; height: 18px;">
                                    <strong>Selecionar Todos</strong>
                                </label>
                            </div>
                            <hr style="margin: 10px 0;">
                            <div id="listaEstudantesSelecao"></div>
                        </div>

                        <button type="button" class="btn btn-primary" onclick="criarCompensacao()" style="margin-top: 20px;">
                            ‚úì Criar e Atribuir Compensa√ß√£o
                        </button>
                    </div>
                </div>
            `;

            document.getElementById('areaNovaCompensacao').innerHTML = html;
            document.getElementById('areaNovaCompensacao').style.display = 'block';
            document.getElementById('areaListaCompensacoes').style.display = 'none';
        }

        function ocultarNovaCompensacao() {
            document.getElementById('areaNovaCompensacao').style.display = 'none';
            document.getElementById('areaListaCompensacoes').style.display = 'block';
        }

        function calcularFaltasNova() {
            const inicio = document.getElementById('novaCompPeriodoInicio').value;
            const fim = document.getElementById('novaCompPeriodoFim').value;

            if (!inicio || !fim) {
                document.getElementById('faltasCalculadas').innerHTML = '';
                document.getElementById('formNovaComp').style.display = 'none';
                return;
            }

            const estudantes = getEstudantesDaTurma(turmaAtual).filter(e => !e.status || e.status === 'Ativo');
            const aulasNoPeriodo = data.aulas.filter(a => 
                a.id_turma === turmaAtual && 
                a.data >= inicio && 
                a.data <= fim
            );

            const faltasPorEstudante = [];

            estudantes.forEach(e => {
                let totalFaltas = 0;

                aulasNoPeriodo.forEach(aula => {
                    const presenca = data.presencas.find(p => 
                        p.id_aula === aula.id && p.id_estudante === e.id
                    );

                    if (presenca && presenca.status === 'falta') {
                        totalFaltas++;
                    }
                });

                faltasPorEstudante.push({
                    estudante: e,
                    total: totalFaltas
                });
            });

            const comFaltas = faltasPorEstudante.filter(f => f.total > 0);
            const totalAulas = aulasNoPeriodo.length;

            const html = `
                <div style="background: #fff; padding: 15px; border-radius: 6px; border: 2px solid #e2e8f0;">
                    <h4>üìä Resumo do Per√≠odo (${formatDate(inicio)} a ${formatDate(fim)})</h4>
                    <div class="stats">
                        <div class="stat-item">
                            <div class="stat-value">${totalAulas}</div>
                            <div class="stat-label">Aulas no Per√≠odo</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" style="color: #ef4444;">${comFaltas.length}</div>
                            <div class="stat-label">Estudantes com Faltas</div>
                        </div>
                    </div>
                    ${comFaltas.length > 0 ? `
                        <table style="margin-top: 15px;">
                            <thead>
                                <tr>
                                    <th>N¬∫</th>
                                    <th>Estudante</th>
                                    <th>Total de Faltas</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${comFaltas.map(f => `
                                    <tr>
                                        <td>${f.estudante.numero_chamada}</td>
                                        <td>${f.estudante.nome_completo}</td>
                                        <td><span class="badge badge-danger">${f.total} falta(s)</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    ` : `
                        <div class="alert alert-success" style="margin-top: 15px;">
                            ‚úì Nenhuma falta registrada neste per√≠odo!
                        </div>
                    `}
                </div>
            `;

            document.getElementById('faltasCalculadas').innerHTML = html;
            document.getElementById('formNovaComp').style.display = 'block';

            // Armazenar e renderizar lista de estudantes
            window.faltasCalculadas = faltasPorEstudante;
            renderListaEstudantesSelecao();
        }

        function renderListaEstudantesSelecao() {
            if (!window.faltasCalculadas) return;

            const html = window.faltasCalculadas.map(f => `
                <label style="display: flex; align-items: center; gap: 10px; padding: 10px; border-radius: 4px; cursor: pointer; ${f.total > 0 ? 'background: #fee2e2;' : ''}" 
                       onmouseover="this.style.background='#f7fafc'" 
                       onmouseout="this.style.background='${f.total > 0 ? '#fee2e2' : 'white'}'">
                    <input type="checkbox" class="estudante-checkbox" value="${f.estudante.id}" 
                           ${f.total > 0 ? 'checked' : ''} 
                           style="width: 18px; height: 18px;">
                    <span style="flex: 1;">
                        <strong>${f.estudante.numero_chamada} - ${f.estudante.nome_completo}</strong>
                        ${f.total > 0 ? `<span class="badge badge-danger" style="margin-left: 10px;">${f.total} falta(s)</span>` : ''}
                    </span>
                </label>
            `).join('');

            document.getElementById('listaEstudantesSelecao').innerHTML = html;
        }

        function selecionarTodosEstudantes(checked) {
            document.querySelectorAll('.estudante-checkbox').forEach(cb => {
                cb.checked = checked;
            });
        }

        function criarCompensacao() {
            const descricao = document.getElementById('novaCompDescricao').value.trim();
            const dataEntrega = document.getElementById('novaCompDataEntrega').value;
            const periodoInicio = document.getElementById('novaCompPeriodoInicio').value;
            const periodoFim = document.getElementById('novaCompPeriodoFim').value;

            if (!descricao) {
                alert('Preencha a descri√ß√£o da compensa√ß√£o!');
                return;
            }

            if (!dataEntrega) {
                alert('Defina a data de entrega!');
                return;
            }

            const estudantesSelecionados = Array.from(document.querySelectorAll('.estudante-checkbox:checked'))
                .map(cb => parseInt(cb.value));

            if (estudantesSelecionados.length === 0) {
                alert('Selecione pelo menos um estudante!');
                return;
            }

            // Criar uma compensa√ß√£o para cada estudante selecionado
            let contador = 0;
            // Nota: Compensa√ß√µes s√£o salvas localmente pelo professor, referenciando o ID do aluno (que √© global)
            estudantesSelecionados.forEach(estudanteId => {
                const faltasEstudante = window.faltasCalculadas.find(f => f.estudante.id === estudanteId);
                
                data.compensacoes.push({
                    id: getNextId(data.compensacoes),
                    id_estudante: estudanteId,
                    id_turma: turmaAtual,
                    periodo_inicio: periodoInicio,
                    periodo_fim: periodoFim,
                    total_faltas: faltasEstudante ? faltasEstudante.total : 0,
                    descricao: descricao,
                    data_entrega: dataEntrega,
                    data_atribuicao: getTodayString(),
                    status: 'pendente',
                    observacoes: '',
                    historico_status: [
                        { status: 'pendente', data: getTodayString() }
                    ],
                    arquivada: false
                });
                contador++;
            });

            persistirDados();
            alert(`‚úì Compensa√ß√£o atribu√≠da para ${contador} estudante(s)!`);
            
            ocultarNovaCompensacao();
            mostrarListaCompensacoes();
        }

        function mostrarListaCompensacoes() {
            const todasCompensacoes = data.compensacoes.filter(c => c.id_turma === turmaAtual);
            
            let compensacoes = todasCompensacoes;
            
            if (filtroDataInicio) {
                compensacoes = compensacoes.filter(c => c.data_atribuicao >= filtroDataInicio);
            }
            if (filtroDataFim) {
                compensacoes = compensacoes.filter(c => c.data_atribuicao <= filtroDataFim);
            }

            if (filtroCompensacoes === 'ativas') {
                compensacoes = compensacoes.filter(c => !c.arquivada);
            } else if (filtroCompensacoes === 'arquivadas') {
                compensacoes = compensacoes.filter(c => c.arquivada);
            } else if (filtroCompensacoes === 'pendentes') {
                compensacoes = compensacoes.filter(c => !c.arquivada && (c.status === 'pendente' || c.status === 'notificado'));
            } else if (filtroCompensacoes === 'entregues') {
                compensacoes = compensacoes.filter(c => !c.arquivada && (c.status === 'entregue' || c.status === 'entregue_atraso'));
            } else if (filtroCompensacoes === 'nao_entregues') {
                compensacoes = compensacoes.filter(c => !c.arquivada && c.status === 'nao_entregue');
            }

            if (compensacoes.length === 0) {
                document.getElementById('areaListaCompensacoes').innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <strong>üîç Filtrar por Status:</strong>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">
                            <button class="btn ${filtroCompensacoes === 'todas' ? 'btn-primary' : 'btn-secondary'}" onclick="filtrarCompensacoes('todas')">
                                Todas (${todasCompensacoes.length})
                            </button>
                            <button class="btn ${filtroCompensacoes === 'ativas' ? 'btn-primary' : 'btn-secondary'}" onclick="filtrarCompensacoes('ativas')">
                                Ativas (${todasCompensacoes.filter(c => !c.arquivada).length})
                            </button>
                            <button class="btn ${filtroCompensacoes === 'pendentes' ? 'btn-primary' : 'btn-secondary'}" onclick="filtrarCompensacoes('pendentes')">
                                Pendentes (${todasCompensacoes.filter(c => !c.arquivada && (c.status === 'pendente' || c.status === 'notificado')).length})
                            </button>
                            <button class="btn ${filtroCompensacoes === 'entregues' ? 'btn-primary' : 'btn-secondary'}" onclick="filtrarCompensacoes('entregues')">
                                Entregues (${todasCompensacoes.filter(c => !c.arquivada && (c.status === 'entregue' || c.status === 'entregue_atraso')).length})
                            </button>
                            <button class="btn ${filtroCompensacoes === 'nao_entregues' ? 'btn-primary' : 'btn-secondary'}" onclick="filtrarCompensacoes('nao_entregues')">
                                N√£o Entregues (${todasCompensacoes.filter(c => !c.arquivada && c.status === 'nao_entregue').length})
                            </button>
                            <button class="btn ${filtroCompensacoes === 'arquivadas' ? 'btn-primary' : 'btn-secondary'}" onclick="filtrarCompensacoes('arquivadas')">
                                Arquivadas (${todasCompensacoes.filter(c => c.arquivada).length})
                            </button>
                        </div>
                    </div>
                    <div style="margin-bottom: 20px; background: #f7fafc; padding: 15px; border-radius: 8px;">
                        <strong>üìÖ Filtrar por Per√≠odo de Atribui√ß√£o:</strong>
                        <div class="form-row" style="margin-top: 10px;">
                            <label>
                                Data In√≠cio:
                                <input type="date" id="filtroDataInicio" value="${filtroDataInicio}" onchange="filtrarPorPeriodo()">
                            </label>
                            <label>
                                Data Fim:
                                <input type="date" id="filtroDataFim" value="${filtroDataFim}" onchange="filtrarPorPeriodo()">
                            </label>
                            <div style="display: flex; align-items: flex-end;">
                                <button class="btn btn-secondary" onclick="limparFiltroPeriodo()">üîÑ Limpar Filtro</button>
                            </div>
                        </div>
                    </div>
                    <p class="empty-state">Nenhuma compensa√ß√£o encontrada com este filtro</p>
                `;
                return;
            }

            // Agrupar por descri√ß√£o (trabalhos iguais)
            const trabalhosAgrupados = {};
            compensacoes.forEach(c => {
                const chave = `${c.descricao}_${c.data_entrega}_${c.periodo_inicio}_${c.periodo_fim}`;
                if (!trabalhosAgrupados[chave]) {
                    trabalhosAgrupados[chave] = {
                        descricao: c.descricao,
                        data_entrega: c.data_entrega,
                        data_atribuicao: c.data_atribuicao,
                        periodo_inicio: c.periodo_inicio,
                        periodo_fim: c.periodo_fim,
                        arquivada: c.arquivada,
                        compensacoes: []
                    };
                }
                trabalhosAgrupados[chave].compensacoes.push(c);
            });

            const html = `
                <div style="margin-bottom: 20px;">
                    <strong>üîç Filtrar por Status:</strong>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">
                        <button class="btn ${filtroCompensacoes === 'todas' ? 'btn-primary' : 'btn-secondary'}" onclick="filtrarCompensacoes('todas')">
                            Todas (${todasCompensacoes.length})
                        </button>
                        <button class="btn ${filtroCompensacoes === 'ativas' ? 'btn-primary' : 'btn-secondary'}" onclick="filtrarCompensacoes('ativas')">
                            Ativas (${todasCompensacoes.filter(c => !c.arquivada).length})
                        </button>
                        <button class="btn ${filtroCompensacoes === 'pendentes' ? 'btn-primary' : 'btn-secondary'}" onclick="filtrarCompensacoes('pendentes')">
                            Pendentes (${todasCompensacoes.filter(c => !c.arquivada && (c.status === 'pendente' || c.status === 'notificado')).length})
                        </button>
                        <button class="btn ${filtroCompensacoes === 'entregues' ? 'btn-primary' : 'btn-secondary'}" onclick="filtrarCompensacoes('entregues')">
                            Entregues (${todasCompensacoes.filter(c => !c.arquivada && (c.status === 'entregue' || c.status === 'entregue_atraso')).length})
                        </button>
                        <button class="btn ${filtroCompensacoes === 'nao_entregues' ? 'btn-primary' : 'btn-secondary'}" onclick="filtrarCompensacoes('nao_entregues')">
                            N√£o Entregues (${todasCompensacoes.filter(c => !c.arquivada && c.status === 'nao_entregue').length})
                        </button>
                        <button class="btn ${filtroCompensacoes === 'arquivadas' ? 'btn-primary' : 'btn-secondary'}" onclick="filtrarCompensacoes('arquivadas')">
                            Arquivadas (${todasCompensacoes.filter(c => c.arquivada).length})
                        </button>
                    </div>
                </div>

                <div style="margin-bottom: 20px; background: #f7fafc; padding: 15px; border-radius: 8px;">
                    <strong>üìÖ Filtrar por Per√≠odo de Atribui√ß√£o:</strong>
                    <div class="form-row" style="margin-top: 10px;">
                        <label>
                            Data In√≠cio:
                            <input type="date" id="filtroDataInicio" value="${filtroDataInicio}" onchange="filtrarPorPeriodo()">
                        </label>
                        <label>
                            Data Fim:
                            <input type="date" id="filtroDataFim" value="${filtroDataFim}" onchange="filtrarPorPeriodo()">
                        </label>
                        <div style="display: flex; align-items: flex-end;">
                            <button class="btn btn-secondary" onclick="limparFiltroPeriodo()">üîÑ Limpar Filtro</button>
                        </div>
                    </div>
                </div>

                <div>
                    ${Object.values(trabalhosAgrupados).map(trabalho => {
                        const totalEstudantes = trabalho.compensacoes.length;
                        const pendentes = trabalho.compensacoes.filter(c => c.status === 'pendente' || c.status === 'notificado').length;
                        const entregues = trabalho.compensacoes.filter(c => c.status === 'entregue' || c.status === 'entregue_atraso').length;
                        const naoEntregues = trabalho.compensacoes.filter(c => c.status === 'nao_entregue').length;

                        return `
                            <div style="background: #fff; padding: 20px; border-radius: 8px; border: 2px solid ${trabalho.arquivada ? '#cbd5e0' : '#e2e8f0'}; margin-bottom: 20px; ${trabalho.arquivada ? 'opacity: 0.7;' : ''}">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                    <div style="flex: 1;">
                                        <h4 style="margin: 0 0 10px 0;">
                                            üìù ${trabalho.descricao}
                                            ${trabalho.arquivada ? '<span class="badge badge-info" style="margin-left: 10px;">Arquivada</span>' : ''}
                                        </h4>
                                        <div style="font-size: 13px; color: #718096;">
                                            <div>üìÖ Per√≠odo: ${formatDate(trabalho.periodo_inicio)} a ${formatDate(trabalho.periodo_fim)}</div>
                                            <div>üìÜ Prazo: ${formatDate(trabalho.data_entrega)}</div>
                                            <div>üìå Atribu√≠do em: ${formatDate(trabalho.data_atribuicao)}</div>
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 10px;">
                                        ${!trabalho.arquivada ? `
                                            <button class="btn btn-secondary" onclick="arquivarTrabalho('${trabalho.descricao}', '${trabalho.data_entrega}', '${trabalho.periodo_inicio}', '${trabalho.periodo_fim}')" title="Arquivar este trabalho">
                                                üì¶ Arquivar
                                            </button>
                                        ` : `
                                            <button class="btn btn-success" onclick="desarquivarTrabalho('${trabalho.descricao}', '${trabalho.data_entrega}', '${trabalho.periodo_inicio}', '${trabalho.periodo_fim}')" title="Desarquivar este trabalho">
                                                üì§ Desarquivar
                                            </button>
                                        `}
                                        <button class="btn btn-danger" onclick="excluirTrabalho('${trabalho.descricao}', '${trabalho.data_entrega}', '${trabalho.periodo_inicio}', '${trabalho.periodo_fim}')" title="Excluir permanentemente">
                                            üóëÔ∏è Excluir
                                        </button>
                                    </div>
                                </div>

                                <div class="stats" style="margin: 15px 0;">
                                    <div class="stat-item">
                                        <div class="stat-value" style="font-size: 20px;">${totalEstudantes}</div>
                                        <div class="stat-label">Total</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-value" style="font-size: 20px; color: #22c55e;">${entregues}</div>
                                        <div class="stat-label">Entregues</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-value" style="font-size: 20px; color: #ffc107;">${pendentes}</div>
                                        <div class="stat-label">Pendentes</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-value" style="font-size: 20px; color: #ef4444;">${naoEntregues}</div>
                                        <div class="stat-label">N√£o Entregues</div>
                                    </div>
                                </div>

                                <h5 style="margin: 15px 0 10px 0;">üë• Estudantes (${totalEstudantes})</h5>
                                <table>
                                    <thead>
                                        <tr>
                                            <th>N¬∫</th>
                                            <th>Estudante</th>
                                            <th>Faltas</th>
                                            <th>Status</th>
                                            <th>A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${trabalho.compensacoes.map(c => {
                                            const estudante = getEstudanteById(c.id_estudante);
                                            const historico = c.historico_status || [];
                                            const historicoHtml = historico.length > 0 
                                                ? historico.map(h => `<div style="font-size: 11px; color: #718096;">${formatDate(h.data)}: ${h.status}</div>`).join('') 
                                                : '';
                                            
                                            return `
                                                <tr>
                                                    <td>${estudante.numero_chamada}</td>
                                                    <td>
                                                        ${estudante.nome_completo}
                                                        ${historicoHtml ? `<div style="margin-top: 5px; padding: 5px; background: #f7fafc; border-radius: 4px;">${historicoHtml}</div>` : ''}
                                                    </td>
                                                    <td><span class="badge badge-danger">${c.total_faltas}</span></td>
                                                    <td>
                                                        <select class="status-select" onchange="alterarStatusCompensacao(${c.id}, this.value)" 
                                                                ${trabalho.arquivada ? 'disabled' : ''}
                                                                style="border-color: ${getStatusColor(c.status)};">
                                                            <option value="pendente" ${c.status === 'pendente' ? 'selected' : ''}>‚è≥ Pendente</option>
                                                            <option value="notificado" ${c.status === 'notificado' ? 'selected' : ''}>üìß Notificado</option>
                                                            <option value="entregue" ${c.status === 'entregue' ? 'selected' : ''}>‚úì Entregue</option>
                                                            <option value="entregue_atraso" ${c.status === 'entregue_atraso' ? 'selected' : ''}>‚ö†Ô∏è Entregue com Atraso</option>
                                                            <option value="nao_entregue" ${c.status === 'nao_entregue' ? 'selected' : ''}>‚úï N√£o Entregue</option>
                                                        </select>
                                                    </td>
                                                    <td>
                                                        <button class="btn btn-danger btn-sm" onclick="removerCompensacao(${c.id})" ${trabalho.arquivada ? 'disabled' : ''}>üóëÔ∏è</button>
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;

            document.getElementById('areaListaCompensacoes').innerHTML = html;
        }

        function filtrarCompensacoes(filtro) {
            filtroCompensacoes = filtro;
            mostrarListaCompensacoes();
        }

        function filtrarPorPeriodo() {
            const inicio = document.getElementById('filtroDataInicio')?.value || '';
            const fim = document.getElementById('filtroDataFim')?.value || '';
            
            filtroDataInicio = inicio;
            filtroDataFim = fim;
            
            mostrarListaCompensacoes();
        }

        function limparFiltroPeriodo() {
            filtroDataInicio = '';
            filtroDataFim = '';
            mostrarListaCompensacoes();
        }

        function arquivarTrabalho(descricao, dataEntrega, periodoInicio, periodoFim) {
            if (confirm('Arquivar este trabalho? Ele n√£o aparecer√° mais na lista ativa, mas poder√° ser consultado depois.')) {
                data.compensacoes.forEach(c => {
                    if (c.id_turma === turmaAtual && 
                        c.descricao === descricao && 
                        c.data_entrega === dataEntrega &&
                        c.periodo_inicio === periodoInicio &&
                        c.periodo_fim === periodoFim) {
                        c.arquivada = true;
                    }
                });
                persistirDados();
                mostrarListaCompensacoes();
            }
        }

        function desarquivarTrabalho(descricao, dataEntrega, periodoInicio, periodoFim) {
            data.compensacoes.forEach(c => {
                if (c.id_turma === turmaAtual && 
                    c.descricao === descricao && 
                    c.data_entrega === dataEntrega &&
                    c.periodo_inicio === periodoInicio &&
                    c.periodo_fim === periodoFim) {
                    c.arquivada = false;
                }
            });
            persistirDados();
            mostrarListaCompensacoes();
        }

        function excluirTrabalho(descricao, dataEntrega, periodoInicio, periodoFim) {
            if (confirm('‚ö†Ô∏è ATEN√á√ÉO: Excluir permanentemente este trabalho e todas as compensa√ß√µes associadas? Esta a√ß√£o n√£o pode ser desfeita!')) {
                data.compensacoes = data.compensacoes.filter(c => 
                    !(c.id_turma === turmaAtual && 
                      c.descricao === descricao && 
                      c.data_entrega === dataEntrega &&
                      c.periodo_inicio === periodoInicio &&
                      c.periodo_fim === periodoFim)
                );
                persistirDados();
                mostrarListaCompensacoes();
            }
        }

        function alterarStatusCompensacao(compId, novoStatus) {
            const comp = data.compensacoes.find(c => c.id === compId);
            if (comp) {
                if (comp.status !== novoStatus) {
                    if (!comp.historico_status) {
                        comp.historico_status = [];
                    }
                    
                    comp.historico_status.push({
                        status: novoStatus,
                        data: getTodayString()
                    });
                    
                    comp.status = novoStatus;
                }
                persistirDados();
                mostrarListaCompensacoes();
            }
        }

        function removerCompensacao(compId) {
            if (confirm('Deseja realmente remover esta compensa√ß√£o deste estudante?')) {
                data.compensacoes = data.compensacoes.filter(c => c.id !== compId);
                persistirDados();
                mostrarListaCompensacoes();
            }
        }

        // CONFIGURA√á√ïES
        function renderConfiguracoes() {
            const horarios = data.horariosAulas.filter(h => h.id_turma === turmaAtual);
            const diasSemana = ['Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado', 'Domingo'];
            const dadosGestao = getDadosGestao();
            const gradeGestao = dadosGestao.gradeHoraria || [];

            const html = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 8px; margin-bottom: 25px;">
                    <h3 style="color: white; margin: 0 0 15px 0; border: none; padding: 0;">‚öôÔ∏è Configura√ß√µes da Turma</h3>
                    <p style="margin: 0; font-size: 14px; opacity: 0.95;">
                        Configure os hor√°rios das aulas desta turma.
                    </p>
                </div>

                <div style="background: #dcfce7; border-left: 4px solid #22c55e; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                    <strong>‚úì Sincroniza√ß√£o Autom√°tica</strong>
                    <p style="margin: 5px 0 0 0; font-size: 14px;">
                        Ao adicionar ou remover hor√°rios, a agenda ser√° atualizada automaticamente para os pr√≥ximos 60 dias.
                    </p>
                </div>

                <div style="margin: 20px 0;">
                    <h4>‚ûï Adicionar Hor√°rio de Aula</h4>
                    <form onsubmit="adicionarHorario(event)" style="background: #f7fafc; padding: 20px; border-radius: 8px; border: 2px dashed #cbd5e0;">
                        <div class="form-row">
                            <label>
                                Dia da Semana:
                                <select id="configDiaSemana" required>
                                    <option value="">Selecione...</option>
                                    <option value="1">Segunda-feira</option>
                                    <option value="2">Ter√ßa-feira</option>
                                    <option value="3">Quarta-feira</option>
                                    <option value="4">Quinta-feira</option>
                                    <option value="5">Sexta-feira</option>
                                    <option value="6">S√°bado</option>
                                    <option value="0">Domingo</option>
                                </select>
                            </label>
                            ${gradeGestao.length > 0 ? `
                                <label style="flex: 2;">
                                    Per√≠odo (Grade da Escola):
                                    <select id="configPeriodoGrade" required>
                                        <option value="">Selecione o hor√°rio...</option>
                                        ${gradeGestao.sort((a,b) => a.inicio.localeCompare(b.inicio)).map(g => `<option value="${g.inicio}|${g.fim}">${g.nome} (${g.inicio} - ${g.fim})</option>`).join('')}
                                    </select>
                                </label>
                            ` : `
                                <label>
                                    Hora In√≠cio: <input type="time" id="configHoraInicio" required>
                                </label>
                                <label>
                                    Hora Fim: <input type="time" id="configHoraFim" required>
                                </label>
                            `}
                        </div>
                        <button type="submit" class="btn btn-primary" style="margin-top: 10px;">‚úì Adicionar Hor√°rio</button>
                    </form>
                </div>

                <div>
                    <h4>üìã Hor√°rios Cadastrados (${horarios.length})</h4>
                    ${horarios.length > 0 ? horarios.map(h => `
                        <div class="schedule-item">
                            <div class="schedule-info">
                                <div class="schedule-day">üìÖ ${diasSemana[h.dia_semana === 0 ? 6 : h.dia_semana - 1]}</div>
                                <div class="schedule-time">‚è∞ ${h.hora_inicio} - ${h.hora_fim}</div>
                            </div>
                            <button class="btn btn-danger" onclick="removerHorario(${h.id})">üóëÔ∏è Remover</button>
                        </div>
                    `).join('') : '<p class="empty-state">Nenhum hor√°rio cadastrado ainda. Use o formul√°rio acima para adicionar.</p>'}
                </div>
            `;

            document.getElementById('tabConfiguracoes').innerHTML = html;
        }

        function adicionarHorario(e) {
            e.preventDefault();

            let inicio, fim;
            const selectGrade = document.getElementById('configPeriodoGrade');
            
            if (selectGrade) {
                [inicio, fim] = selectGrade.value.split('|');
            } else {
                inicio = document.getElementById('configHoraInicio').value;
                fim = document.getElementById('configHoraFim').value;
            }

            const novoHorario = {
                id: getNextId(data.horariosAulas),
                id_turma: turmaAtual,
                dia_semana: parseInt(document.getElementById('configDiaSemana').value),
                hora_inicio: inicio,
                hora_fim: fim
            };

            data.horariosAulas.push(novoHorario);
            persistirDados();
            sincronizarAgenda();
            renderConfiguracoes();
            e.target.reset();
            
            alert('Hor√°rio adicionado e agenda sincronizada!');
        }

        function removerHorario(id) {
            if (confirm('Deseja remover este hor√°rio? A agenda ser√° atualizada automaticamente.')) {
                data.horariosAulas = data.horariosAulas.filter(h => h.id !== id);
                persistirDados();
                sincronizarAgenda();
                renderConfiguracoes();
                alert('Hor√°rio removido e agenda atualizada!');
            }
        }

        function sincronizarAgenda() {
            // Remove eventos de aula antigos
            data.eventos = data.eventos.filter(e => e.tipo !== 'Aula');
            
            // Adiciona novos eventos baseados nos hor√°rios
            const hoje = new Date();
            const diasParaSincronizar = 60;
            
            data.turmas.forEach(turma => {
                const horariosTurma = data.horariosAulas.filter(h => h.id_turma === turma.id);
                
                for (let i = 0; i < diasParaSincronizar; i++) {
                    const dataEvento = new Date(hoje);
                    dataEvento.setDate(hoje.getDate() + i);
                    const diaSemana = dataEvento.getDay();
                    
                    horariosTurma.forEach(horario => {
                        if (horario.dia_semana === diaSemana) {
                            const dataStr = dataEvento.toISOString().split('T')[0];
                            const eventoExistente = data.eventos.find(e => 
                                e.data === dataStr && 
                                e.hora_inicio === horario.hora_inicio && 
                                e.tipo === 'Aula' &&
                                e.id_turma === turma.id
                            );
                            
                            if (!eventoExistente) {
                                data.eventos.push({
                                    id: getNextId(data.eventos),
                                    tipo: 'Aula',
                                    id_turma: turma.id,
                                    turma_nome: `${turma.nome} - ${turma.disciplina}`,
                                    data: dataStr,
                                    hora_inicio: horario.hora_inicio,
                                    hora_fim: horario.hora_fim,
                                    descricao: `Aula de ${turma.disciplina} - ${turma.nome}`
                                });
                            }
                        }
                    });
                }
            });
            
            if (document.getElementById('agenda').classList.contains('active')) {
                renderAgenda();
            }
            persistirDados();
        }

        // TUTORIA
        function renderTutoria() {
            const isGestor = currentUser && currentUser.role === 'gestor';
            
            // Esconder bot√£o de configura√ß√£o para professor
            const btnConfig = document.getElementById('btnConfigTutoria');
            if (btnConfig) btnConfig.style.display = isGestor ? 'inline-block' : 'none';

            const tutoradosHtml = data.tutorados.length > 0 ? `
                <table>
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Turma</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.tutorados.map(t => `
                            <tr>
                                <td><a href="#" onclick="abrirFichaTutorado(${t.id}); return false;" style="color: #3182ce; font-weight: bold; text-decoration: none;">${t.nome_estudante}</a></td>
                                <td>${t.turma}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : '<p class="empty-state">Nenhum tutorado cadastrado</p>';

            document.getElementById('listaTutorados').innerHTML = tutoradosHtml;

            const encontrosHtml = data.encontros.length > 0 ? `
                <table>
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Tutorado</th>
                            <th>Tema</th>
                            <th>Resumo</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.encontros.map(e => {
                            const tutorado = data.tutorados.find(t => t.id === e.id_tutorado);
                            return `
                                <tr>
                                    <td>${formatDate(e.data)}</td>
                                    <td>${tutorado ? tutorado.nome_estudante : '-'}</td>
                                    <td>${e.tema}</td>
                                    <td>${e.resumo}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            ` : '<p class="empty-state">Nenhum encontro registrado</p>';

            document.getElementById('listaEncontros').innerHTML = encontrosHtml;

            // Adicionar bot√£o de registrar encontro no dashboard de tutoria
            const cardEncontros = document.getElementById('listaEncontros').parentElement;
            if (!cardEncontros.querySelector('.btn-registrar-extra')) {
                // J√° existe o bot√£o "+ Registrar Encontro" no HTML original, mantendo-o.
            }
        }

        function abrirFichaTutorado(id) {
            const tutorado = data.tutorados.find(t => t.id === id);
            if (!tutorado) return;

            document.getElementById('tutoradoFichaNome').textContent = tutorado.nome_estudante;

            // Adicionar bot√µes de a√ß√£o na ficha
            const header = document.getElementById('tutoradoFichaNome').parentElement;
            if (!document.getElementById('btnAcoesTutorado')) {
                const div = document.createElement('div');
                div.id = 'btnAcoesTutorado';
                div.innerHTML = `<button class="btn btn-secondary btn-sm" onclick="imprimirRelatorioTutorado(${id})">üñ®Ô∏è Relat√≥rio</button> <button class="btn btn-danger btn-sm" onclick="excluirTutorado(${id})">üóëÔ∏è Excluir</button>`;
                header.appendChild(div);
            }

            // Agendamentos
            const agendamentos = data.agendamentos
                .filter(a => a.id_tutorado === id)
                .sort((a, b) => {
                    if (a.data !== b.data) return a.data.localeCompare(b.data);
                    return a.hora.localeCompare(b.hora);
                });

            const htmlAgendamentos = agendamentos.length > 0 ? `
                <ul style="list-style: none; padding: 0;">
                    ${agendamentos.map(a => `
                        <li style="background: white; padding: 10px; border-radius: 6px; margin-bottom: 8px; border: 1px solid #bee3f8;">
                            <strong>${formatDate(a.data)} √†s ${a.hora}</strong>
                            <button class="btn btn-sm btn-secondary" style="float:right;" onclick="imprimirAgendamentoUnico(${id})">üñ®Ô∏è</button>
                            <div style="font-size: 12px; color: #718096; margin-top: 4px;">Dura√ß√£o: ${a.duracao} min</div>
                        </li>
                    `).join('')}
                </ul>
            ` : '<p class="empty-state" style="font-size: 13px;">Nenhum agendamento futuro.</p>';
            
            document.getElementById('tutoradoFichaAgendamentos').innerHTML = htmlAgendamentos;

            // Hist√≥rico (Encontros)
            const encontros = data.encontros
                .filter(e => e.id_tutorado === id)
                .sort((a, b) => new Date(b.data) - new Date(a.data));

            const htmlHistorico = encontros.length > 0 ? `
                <ul style="list-style: none; padding: 0;">
                    ${encontros.map(e => `
                        <li style="background: white; padding: 10px; border-radius: 6px; margin-bottom: 8px; border: 1px solid #bbf7d0;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <strong>${formatDate(e.data)}</strong>
                                <span class="badge badge-success">Realizado</span>
                            </div>
                            <div style="font-weight: 600; font-size: 14px; color: #2d3748;">${e.tema}</div>
                            <div style="font-size: 13px; color: #4a5568; margin-top: 5px; line-height: 1.4;">${e.resumo}</div>
                        </li>
                    `).join('')}
                </ul>
            ` : '<p class="empty-state" style="font-size: 13px;">Nenhum encontro registrado.</p>';

            document.getElementById('tutoradoFichaHistorico').innerHTML = htmlHistorico;

            showScreen('tutoradoDetalhe');
        }

        function excluirTutorado(id) {
            if (confirm('Remover este tutorado e todos os seus registros?')) {
                data.tutorados = data.tutorados.filter(t => t.id !== id);
                data.agendamentos = data.agendamentos.filter(a => a.id_tutorado !== id);
                data.encontros = data.encontros.filter(e => e.id_tutorado !== id);
                persistirDados();
                showScreen('tutoria');
            }
        }

        function imprimirAgendamentoUnico(tutoradoId) {
            const periodo = prompt("Digite o m√™s/ano para filtrar (ex: 02/2026) ou deixe em branco para todos:");
            // L√≥gica simplificada de impress√£o
            const tutorado = data.tutorados.find(t => t.id === tutoradoId);
            const agendamentos = data.agendamentos.filter(a => a.id_tutorado === tutoradoId);
            
            let html = `<h2>Agendamentos: ${tutorado.nome_estudante}</h2><ul>`;
            agendamentos.forEach(a => {
                html += `<li>${formatDate(a.data)} √†s ${a.hora}</li>`;
            });
            html += '</ul>';
            
            const win = window.open('', '_blank');
            win.document.write(html);
            win.print();
        }

        function imprimirRelatorioTutorado(id) {
            // Similar ao acima, mas para encontros realizados
            alert('Funcionalidade de impress√£o de relat√≥rio completa seria implementada aqui.');
        }

        function salvarTutorado(e) {
            e.preventDefault();

            const novoTutorado = {
                id: getNextId(data.tutorados),
                nome_estudante: document.getElementById('tutoradoNome').value,
                turma: document.getElementById('tutoradoTurma').value
            };

            data.tutorados.push(novoTutorado);
            persistirDados();
            closeModal('modalNovoTutorado');
            renderTutoria();
            e.target.reset();
        }

        function salvarEncontro(e) {
            e.preventDefault();

            const novoEncontro = {
                id: getNextId(data.encontros),
                id_tutorado: parseInt(document.getElementById('encontroTutorado').value),
                data: document.getElementById('encontroData').value,
                tema: document.getElementById('encontroTema').value,
                resumo: document.getElementById('encontroResumo').value
            };

            data.encontros.push(novoEncontro);
            persistirDados();
            closeModal('modalNovoEncontro');
            renderTutoria();
            e.target.reset();
        }

        function toggleAgendamentoRecorrenciaUI() {
            const tipo = document.getElementById('agendamentoRecorrenciaTipo').value;
            const divFim = document.getElementById('divAgendamentoRecorrenciaFim');
            const divPers = document.getElementById('divAgendamentoRecorrenciaPersonalizada');
            const inputFim = document.getElementById('agendamentoRecorrenciaFim');
            
            // Se for baseado na grade de tutoria, esconde op√ß√µes manuais de hora
            const usarGradeTutoria = document.getElementById('usarGradeTutoria')?.checked;
            if (usarGradeTutoria) return; // UI controlada por outra fun√ß√£o
            
            const temRecorrencia = tipo !== 'nao';
            divFim.style.display = temRecorrencia ? 'block' : 'none';
            inputFim.required = temRecorrencia;
            
            divPers.style.display = tipo === 'personalizado' ? 'block' : 'none';
        }

        window.tempSlots = [];
        window.previewWeekOffset = 0;

        function previewHorariosAuto(e) {
            e.preventDefault();
            
            // Verificar se deve usar a grade do gestor
            const usarGradeTutoria = document.getElementById('usarGradeTutoria')?.checked;
            
            const dataInicio = document.getElementById('agendamentoInicio').value;
            const recorrenciaTipo = document.getElementById('agendamentoRecorrenciaTipo').value;
            const dataFimRecorrencia = document.getElementById('agendamentoRecorrenciaFim').value;
            let slots = [];

            if (usarGradeTutoria) {
                // L√≥gica baseada na Grade do Gestor (Eventos "Tutoria")
                const dadosGestao = getDadosGestao();
                const grade = dadosGestao.gradeHoraria || [];
                const slotsTutoria = grade.filter(g => g.nome.toLowerCase().includes('tutoria'));

                if (slotsTutoria.length === 0) {
                    alert('N√£o foram encontrados hor√°rios de "Tutoria" na grade definida pela gest√£o.');
                    return;
                }

                let dataAtual = new Date(dataInicio + 'T12:00:00');
                // Define um limite padr√£o se n√£o houver data fim (ex: 30 dias)
                const dataLimite = dataFimRecorrencia ? new Date(dataFimRecorrencia + 'T12:00:00') : new Date(dataAtual.getTime() + (30 * 24 * 60 * 60 * 1000));

                while (dataAtual <= dataLimite) {
                    const diaSemana = dataAtual.getDay();
                    // Verificar se h√° slot de tutoria neste dia
                    slotsTutoria.forEach(slot => {
                        if (slot.dias.includes(diaSemana)) {
                            slots.push({
                                data: dataAtual.toISOString().split('T')[0],
                                hora: slot.inicio
                            });
                        }
                    });
                    dataAtual.setDate(dataAtual.getDate() + 1);
                }

            } else {
                // L√≥gica Manual Antiga
                const horaInicio = document.getElementById('agendamentoHoraInicio').value;

                let dataAtual = new Date(dataInicio + 'T12:00:00');
                
                const addSlot = (dataStr) => {
                    slots.push({
                        data: dataStr,
                        hora: horaInicio
                    });
                };

                if (recorrenciaTipo === 'nao') {
                    addSlot(dataInicio);
                } else {
                    const dataFim = new Date(dataFimRecorrencia + 'T12:00:00');

                    if (recorrenciaTipo === 'semanal') {
                        while (dataAtual <= dataFim) {
                            addSlot(dataAtual.toISOString().split('T')[0]);
                            dataAtual.setDate(dataAtual.getDate() + 7);
                        }
                    } else if (recorrenciaTipo === 'mensal') {
                        let mesesAdicionados = 0;
                        while (true) {
                            let proximaData = new Date(dataInicio + 'T12:00:00');
                            proximaData.setMonth(proximaData.getMonth() + mesesAdicionados);
                            if (proximaData > dataFim) break;
                            addSlot(proximaData.toISOString().split('T')[0]);
                            mesesAdicionados++;
                        }
                    } else if (recorrenciaTipo === 'personalizado') {
                        const checkboxes = document.querySelectorAll('input[name="diaAgendamento"]:checked');
                        const diasSelecionados = Array.from(checkboxes).map(cb => parseInt(cb.value));
                        
                        if (diasSelecionados.length === 0) {
                            alert('Selecione pelo menos um dia da semana.');
                            return;
                        }

                        while (dataAtual <= dataFim) {
                            if (diasSelecionados.includes(dataAtual.getDay())) {
                                addSlot(dataAtual.toISOString().split('T')[0]);
                            }
                            dataAtual.setDate(dataAtual.getDate() + 1);
                        }
                    }
                }
            }

            if (slots.length === 0) {
                alert('Nenhum hor√°rio gerado.');
                return;
            }

            window.tempSlots = slots;
            window.previewWeekOffset = 0;
            
            document.getElementById('qtdHorariosGerados').textContent = slots.length;
            document.getElementById('listaHorariosPreview').innerHTML = slots.map(s => 
                `<div style="padding: 4px; border-bottom: 1px solid #e2e8f0;">üìÖ ${formatDate(s.data)} √†s ${s.hora}</div>`
            ).join('');
            renderPreviewSemanal();
            
            document.getElementById('areaPreviewAgendamento').style.display = 'block';
        }

        function mudarSemanaPreview(direcao) {
            window.previewWeekOffset += direcao;
            renderPreviewSemanal();
        }

        function renderPreviewSemanal() {
            if (window.tempSlots.length === 0) return;

            // Encontrar a data inicial (primeiro slot)
            const datas = window.tempSlots.map(s => new Date(s.data + 'T12:00:00'));
            const minDate = new Date(Math.min.apply(null, datas));
            
            // Ajustar para o in√≠cio da semana (Domingo)
            const startOfWeek = new Date(minDate);
            startOfWeek.setDate(minDate.getDate() - minDate.getDay());
            
            // Aplicar offset
            startOfWeek.setDate(startOfWeek.getDate() + (window.previewWeekOffset * 7));
            
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);

            // Filtrar slots
            const slotsNaSemana = window.tempSlots.filter(s => {
                const d = new Date(s.data + 'T12:00:00');
                return d >= startOfWeek && d <= endOfWeek;
            });

            // Renderizar
            document.getElementById('previewSemanaTexto').textContent = `${startOfWeek.toLocaleDateString('pt-BR')} - ${endOfWeek.toLocaleDateString('pt-BR')}`;
            
            const html = slotsNaSemana.length > 0 ? slotsNaSemana.map(s => {
                const diaSemana = new Date(s.data + 'T12:00:00').toLocaleDateString('pt-BR', { weekday: 'long' });
                return `<div style="padding: 6px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between;"><span>üìÖ ${formatDate(s.data)} (${diaSemana})</span> <strong>${s.hora}</strong></div>`;
            }).join('') : '<div style="padding: 10px; text-align: center; color: #718096;">Nenhum hor√°rio nesta semana</div>';

            document.getElementById('listaHorariosPreview').innerHTML = html;
        }

        function confirmarDistribuicaoAuto() {
            if (data.tutorados.length === 0) {
                alert('Voc√™ n√£o possui tutorados cadastrados para agendar.');
                return;
            }

            const duracao = parseInt(document.getElementById('agendamentoDuracao').value);

            // Distribuir Tutorados
            let agendadosCount = 0;
            let tutoradoIndex = 0;

            window.tempSlots.forEach(slot => {
                // Distribui ciclicamente (se houver mais slots que alunos, repete a lista)
                const tutorado = data.tutorados[tutoradoIndex % data.tutorados.length];
                
                data.agendamentos.push({
                    id: getNextId(data.agendamentos),
                    id_tutorado: tutorado.id,
                    data: slot.data,
                    hora: slot.hora,
                    duracao: duracao
                });
                agendadosCount++;
                tutoradoIndex++;
            });

            persistirDados();
            alert(`Agendamento conclu√≠do! ${agendadosCount} atendimentos agendados.`);
            closeModal('modalGerarAgendamento');
            document.getElementById('areaPreviewAgendamento').style.display = 'none';
            abrirListaAgendamentos();
        }

        function abrirListaAgendamentos() {
            const agendamentos = data.agendamentos.sort((a, b) => {
                if (a.data !== b.data) return a.data.localeCompare(b.data);
                return a.hora.localeCompare(b.hora);
            });

            const html = agendamentos.length > 0 ? `
                <table>
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Hora</th>
                            <th>Tutorado</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${agendamentos.map(a => {
                            const tutorado = data.tutorados.find(t => t.id === a.id_tutorado);
                            return `
                                <tr>
                                    <td>${formatDate(a.data)}</td>
                                    <td>${a.hora}</td>
                                    <td>${tutorado ? tutorado.nome_estudante : '?'}</td>
                                    <td>
                                        <button class="btn btn-danger btn-sm" onclick="removerAgendamento(${a.id})">üóëÔ∏è</button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            ` : '<p class="empty-state">Nenhum agendamento futuro.</p>';

            document.getElementById('listaAgendamentosConteudo').innerHTML = html;
            showModal('modalListaAgendamentos');
        }

        function removerAgendamento(id) {
            if(confirm('Cancelar este agendamento?')) {
                data.agendamentos = data.agendamentos.filter(a => a.id !== id);
                persistirDados();
                abrirListaAgendamentos();
            }
        }

        // AGENDA
        window.visualizacaoAgenda = 'mes';
        window.dataAtualAgenda = new Date();

        function renderAgenda() {
            // Default para semana se n√£o definido
            if (!window.visualizacaoAgenda) window.visualizacaoAgenda = 'semana';
            
            document.getElementById('btnVisMes').className = window.visualizacaoAgenda === 'mes' ? 'btn btn-primary' : 'btn btn-secondary';
            document.getElementById('btnVisSemana').className = window.visualizacaoAgenda === 'semana' ? 'btn btn-primary' : 'btn btn-secondary';

            if (window.visualizacaoAgenda === 'mes') {
                renderCalendarioMes();
            } else {
                renderCalendarioSemana();
            }

            renderListaEventos();
        }

        function alternarVisualizacao(tipo) {
            window.visualizacaoAgenda = tipo;
            renderAgenda();
        }

        function navegarPeriodo(direcao) {
            if (window.visualizacaoAgenda === 'mes') {
                window.dataAtualAgenda.setMonth(window.dataAtualAgenda.getMonth() + direcao);
            } else {
                window.dataAtualAgenda.setDate(window.dataAtualAgenda.getDate() + (7 * direcao));
            }
            renderAgenda();
        }

        function renderCalendarioMes() {
            const ano = window.dataAtualAgenda.getFullYear();
            const mes = window.dataAtualAgenda.getMonth();
            
            const meses = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 
                          'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            
            document.getElementById('tituloCalendario').textContent = `${meses[mes]} ${ano}`;

            const primeiroDia = new Date(ano, mes, 1);
            const ultimoDia = new Date(ano, mes + 1, 0);
            const diasNoMes = ultimoDia.getDate();
            const diaSemanaInicio = primeiroDia.getDay();

            const hoje = new Date();
            const hojeStr = hoje.toISOString().split('T')[0];

            let html = `
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px;">
                    ${['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'].map(d => 
                        `<div style="text-align: center; font-weight: 600; padding: 10px; background: #4a5568; color: white; border-radius: 6px;">${d}</div>`
                    ).join('')}
            `;

            for (let i = 0; i < diaSemanaInicio; i++) {
                html += `<div style="background: #f7fafc; border-radius: 6px; min-height: 100px;"></div>`;
            }

            for (let dia = 1; dia <= diasNoMes; dia++) {
                const dataStr = `${ano}-${String(mes + 1).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
                const eventosNoDia = obterEventosDoDia(dataStr);
                const ehHoje = dataStr === hojeStr;

                html += `
                    <div class="calendario-dia" style="border-color: ${ehHoje ? '#3182ce' : '#e2e8f0'}; ${ehHoje ? 'box-shadow: 0 0 10px rgba(49, 130, 206, 0.3);' : ''}">
                        <div style="font-weight: 600; margin-bottom: 5px; color: ${ehHoje ? '#3182ce' : '#2d3748'};">${dia}</div>
                        ${eventosNoDia.slice(0, 3).map(e => {
                            const cor = e.tipo === 'Aula' ? '#22c55e' : (e.tipo === 'Tutoria' ? '#805ad5' : '#3182ce');
                            const icone = getIconeChamada(e);
                            
                            let clickAction = `abrirDetalhesEvento('${e.id}')`;
                            if (e.tipo === 'Aula') clickAction = `abrirTurma(${e.id_turma})`;
                            if (e.tipo === 'Tutoria') clickAction = `abrirFichaTutorado(${e.id_tutorado})`;

                            return `<div class="evento-calendario" onclick="${clickAction}" style="background: ${cor}; color: white; cursor: pointer;" title="${e.descricao || e.tipo} (${e.hora_inicio}-${e.hora_fim})">${icone} ${e.turma_nome || e.descricao || e.tipo}</div>`;
                        }).join('')}
                        ${eventosNoDia.length > 3 ? `<div style="font-size: 10px; color: #718096; text-align: center;">+${eventosNoDia.length - 3} mais</div>` : ''}
                    </div>
                `;
            }

            html += `</div>`;
            document.getElementById('calendarioView').innerHTML = html;
        }

        function renderCalendarioSemana() {
            const hoje = new Date(window.dataAtualAgenda);
            const diaSemana = hoje.getDay();
            const segundaFeira = new Date(hoje);
            segundaFeira.setDate(hoje.getDate() - diaSemana + (diaSemana === 0 ? -6 : 1));

            const opcoes = { day: '2-digit', month: 'short' };
            const fimSemana = new Date(segundaFeira);
            fimSemana.setDate(segundaFeira.getDate() + 6);
            document.getElementById('tituloCalendario').textContent = 
                `${segundaFeira.toLocaleDateString('pt-BR', opcoes)} - ${fimSemana.toLocaleDateString('pt-BR', opcoes)} ${fimSemana.getFullYear()}`;

            const diasSemana = ['Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado', 'Domingo'];
            const hojeStr = new Date().toISOString().split('T')[0];

            // Obter Grade do Gestor
            const dadosGestao = getDadosGestao();
            const gradeGestor = (dadosGestao.gradeHoraria || []).sort((a,b) => a.inicio.localeCompare(b.inicio));

            const datasSemanais = [];
            for (let i = 0; i < 7; i++) {
                const dia = new Date(segundaFeira);
                dia.setDate(segundaFeira.getDate() + i);
                datasSemanais.push(dia.toISOString().split('T')[0]);
            }

            let html = `
                <div class="grade-semanal">
                    <div style="display: grid; grid-template-columns: 80px repeat(7, 1fr); gap: 2px; background: #e2e8f0; border-radius: 8px; overflow: hidden;">
                        <div style="background: #4a5568; color: white; padding: 15px; text-align: center; font-weight: 600; position: sticky; top: 0; z-index: 10;">Hor√°rio</div>
            `;

            datasSemanais.forEach((dataStr, idx) => {
                const dia = new Date(dataStr);
                const ehHoje = dataStr === hojeStr;
                html += `
                    <div style="background: ${ehHoje ? '#3182ce' : '#4a5568'}; color: white; padding: 15px; text-align: center; position: sticky; top: 0; z-index: 10;">
                        <div style="font-size: 14px; font-weight: 600;">${diasSemana[idx]}</div>
                        <div style="font-size: 18px; font-weight: 700; margin-top: 5px;">${dia.getDate()}</div>
                    </div>
                `;
            });

            html += '</div>';

            // Se n√£o houver grade, fallback para hor√°rio padr√£o ou mensagem
            const linhasGrade = gradeGestor.length > 0 ? gradeGestor : [
                { nome: 'Manh√£ 1', inicio: '07:00', fim: '08:00', dias: [1,2,3,4,5] },
                { nome: 'Manh√£ 2', inicio: '08:00', fim: '09:00', dias: [1,2,3,4,5] }
            ]; // Fallback simples apenas visual

            linhasGrade.forEach(slot => {
                
                html += `
                    <div style="display: grid; grid-template-columns: 80px repeat(7, 1fr); gap: 2px; min-height: 60px;">
                        <div style="background: #f7fafc; padding: 10px; text-align: right; font-size: 11px; font-weight: 600; color: #4a5568; border-right: 2px solid #cbd5e0; display: flex; flex-direction: column; justify-content: center;">
                            <div>${slot.inicio}</div>
                            <div style="color: #a0aec0; font-size: 10px;">${slot.fim}</div>
                            <div style="margin-top: 2px; color: #3182ce;">${slot.nome}</div>
                        </div>
                `;

                datasSemanais.forEach((dataStr, diaIdx) => {
                    const diaSemanaAtual = new Date(dataStr).getDay();
                    
                    // Verificar se este slot existe neste dia na grade
                    const slotAtivo = slot.dias.includes(diaSemanaAtual);

                    const eventosNaHora = obterEventosDoDia(dataStr).filter(e => {
                        // Compara√ß√£o simplificada por hora de in√≠cio
                        return e.hora_inicio === slot.inicio;
                    });

                    const ehHoje = dataStr === hojeStr;
                    const bgStyle = slotAtivo ? (ehHoje ? 'background: #ebf8ff;' : 'background: white;') : 'background: #edf2f7; opacity: 0.5;';

                    if (eventosNaHora.length > 0) {
                        html += `
                            <div style="${bgStyle} padding: 5px; position: relative; min-height: 60px; border-bottom: 1px solid #e2e8f0;">
                                ${eventosNaHora.map(e => {
                                    const cor = e.tipo === 'Aula' ? '#22c55e' : (e.tipo === 'Tutoria' ? '#805ad5' : '#3182ce');
                                    const icone = getIconeChamada(e);
                                    
                                    let clickAction = `abrirDetalhesEvento('${e.id}')`;
                                    if (e.tipo === 'Aula') clickAction = `abrirTurma(${e.id_turma})`;
                                    if (e.tipo === 'Tutoria') clickAction = `abrirFichaTutorado(${e.id_tutorado})`;

                                    return `
                                        <div onclick="${clickAction}" style="background: ${cor}; color: white; padding: 8px; border-radius: 4px; margin-bottom: 3px; font-size: 11px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer;">
                                            <div style="font-weight: 700; display: flex; justify-content: space-between;"><span>${e.turma_nome || e.descricao || e.tipo}</span> <span>${icone}</span></div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `;
                    } else {
                        if (slotAtivo) {
                            html += `<div onclick="abrirModalEventoSlot('${dataStr}', '${slot.inicio}', '${slot.fim}')" style="${bgStyle} min-height: 60px; border-bottom: 1px solid #e2e8f0; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#bee3f8'" onmouseout="this.style.background='${ehHoje ? '#ebf8ff' : 'white'}'" title="Adicionar a√ß√£o em ${slot.nome}"></div>`;
                        } else {
                            html += `<div style="${bgStyle} min-height: 60px; border-bottom: 1px solid #e2e8f0;"></div>`;
                        }
                    }
                });

                html += '</div>';
            });

            html += '</div>';
            document.getElementById('calendarioView').innerHTML = html;
        }

        function imprimirAgendaMensal() {
            const mes = prompt("Qual m√™s deseja imprimir? (1-12)", new Date().getMonth() + 1);
            if (!mes) return;
            
            const ano = new Date().getFullYear();
            const dataInicio = new Date(ano, mes - 1, 1);
            const dataFim = new Date(ano, mes, 0);
            
            let html = `
                <html><head><title>Agenda Mensal</title>
                <style>
                    body { font-family: sans-serif; }
                    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; page-break-inside: avoid; }
                    th, td { border: 1px solid #000; padding: 5px; font-size: 12px; }
                    h2 { text-align: center; }
                </style>
                </head><body>
                <h2>Agenda - M√™s ${mes}/${ano}</h2>
            `;

            // Gerar tabelas semanais (simplificado)
            // Loop pelas semanas...
            html += `<p>Visualiza√ß√£o de impress√£o gerada para o m√™s inteiro (formato de lista para economia de papel).</p>`;
            const eventosMes = data.eventos.filter(e => new Date(e.data).getMonth() === (mes - 1));
            eventosMes.sort((a,b) => a.data.localeCompare(b.data));
            
            html += `<ul>${eventosMes.map(e => `<li>${formatDate(e.data)} ${e.hora_inicio}: ${e.descricao || e.tipo}</li>`).join('')}</ul>`;
            
            const win = window.open('', '_blank');
            win.document.write(html);
        }

        function getIconeChamada(evento) {
            if (evento.tipo !== 'Aula') return '';
            
            const horario = data.horariosAulas.find(h => 
                h.id_turma === evento.id_turma && 
                h.hora_inicio === evento.hora_inicio
            );
            
            if (!horario) return '';

            const aula = data.aulas.find(a => 
                a.id_turma === evento.id_turma && 
                a.data === evento.data && 
                a.horario_id === horario.id
            );

            if (aula && aula.chamada_realizada) return '‚úÖ';
            if (evento.data <= getTodayString()) return '‚ùå';
            
            return '';
        }

        function obterEventosDoDia(dataStr) {
            const eventos = data.eventos.filter(e => e.data === dataStr);
            
            const tutorias = data.agendamentos.filter(a => a.data === dataStr).map(a => {
                const tutorado = data.tutorados.find(t => t.id === a.id_tutorado);
                const [h, m] = a.hora.split(':').map(Number);
                const dataFim = new Date(0, 0, 0, h, m + a.duracao);
                const horaFim = `${String(dataFim.getHours()).padStart(2, '0')}:${String(dataFim.getMinutes()).padStart(2, '0')}`;
                
                return {
                    id: `tutoria_${a.id}`,
                    tipo: 'Tutoria',
                    data: a.data,
                    hora_inicio: a.hora,
                    hora_fim: horaFim,
                    descricao: `Tutoria: ${tutorado ? tutorado.nome_estudante : 'Estudante removido'}`,
                    turma_nome: tutorado ? `Tut-${tutorado.nome_estudante}` : '',
                    id_tutorado: a.id_tutorado
                };
            });

            return [...eventos, ...tutorias]
                .sort((a, b) => a.hora_inicio.localeCompare(b.hora_inicio));
        }

        function renderListaEventos() {
            // Combinar eventos para a lista
            const todosEventos = [];
            
            // 1. Eventos normais
            data.eventos.forEach(e => todosEventos.push(e));
            
            // 2. Tutorias
            data.agendamentos.forEach(a => {
                const tutorado = data.tutorados.find(t => t.id === a.id_tutorado);
                const [h, m] = a.hora.split(':').map(Number);
                const dataFim = new Date(0, 0, 0, h, m + a.duracao);
                const horaFim = `${String(dataFim.getHours()).padStart(2, '0')}:${String(dataFim.getMinutes()).padStart(2, '0')}`;
                
                todosEventos.push({
                    id: `tutoria_${a.id}`,
                    tipo: 'Tutoria',
                    data: a.data,
                    hora_inicio: a.hora,
                    hora_fim: horaFim,
                    descricao: `Tutoria: ${tutorado ? tutorado.nome_estudante : 'Estudante removido'}`,
                    turma_nome: tutorado ? `Tut-${tutorado.nome_estudante}` : ''
                });
            });

            const eventosOrdenados = todosEventos.sort((a, b) => {
                if (a.data !== b.data) return a.data.localeCompare(b.data);
                return a.hora_inicio.localeCompare(b.hora_inicio);
            });

            const eventosHtml = eventosOrdenados.length > 0 ? `
                <table>
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Tipo</th>
                            <th>Hor√°rio</th>
                            <th>Descri√ß√£o</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${eventosOrdenados.map(e => `
                            <tr>
                                <td>${formatDate(e.data)}</td>
                                <td>
                                    <span class="badge ${e.tipo === 'Aula' ? 'badge-success' : (e.tipo === 'Tutoria' ? 'badge-warning' : 'badge-info')}" style="${e.tipo === 'Tutoria' ? 'background: #805ad5; color: white;' : ''}">
                                        ${e.tipo}
                                    </span>
                                </td>
                                <td>${e.hora_inicio} - ${e.hora_fim}</td>
                                <td>${e.descricao || e.turma_nome || '-'}</td>
                                <td>
                                    <button class="btn btn-danger btn-sm" onclick="removerEvento('${e.id}')">üóëÔ∏è</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : '<p class="empty-state">Nenhum evento cadastrado</p>';

            document.getElementById('listaEventos').innerHTML = eventosHtml;
        }

        function removerEvento(id) {
            // Remover Tutoria
            if (typeof id === 'string' && id.startsWith('tutoria_')) {
                const idAgendamento = parseInt(id.split('_')[1]);
                if (confirm('Deseja cancelar este agendamento de tutoria?')) {
                    data.agendamentos = data.agendamentos.filter(a => a.id !== idAgendamento);
                    renderAgenda();
                    persistirDados();
                }
                return;
            }

            // Remover Evento Normal
            if (confirm('Deseja remover este evento?')) {
                data.eventos = data.eventos.filter(e => e.id !== parseInt(id));
                renderAgenda();
                persistirDados();
            }
        }

        function abrirModalEventoSlot(dataStr, inicio, fim) {
            document.getElementById('eventoData').value = dataStr;
            document.getElementById('eventoHoraInicio').value = inicio;
            document.getElementById('eventoHoraFim').value = fim;
            
            // Configurar UI
            const selectTipo = document.getElementById('eventoTipo');
            selectTipo.value = "";
            toggleEventoTipoUI();
            
            // Listener para mudan√ßa de tipo
            selectTipo.onchange = toggleEventoTipoUI;

            showModal('modalNovoEvento');
        }

        function toggleEventoTipoUI() {
            const tipo = document.getElementById('eventoTipo').value;
            const divTurma = document.getElementById('divEventoTurma');
            const selectTurma = document.getElementById('eventoTurmaSelect');
            
            divTurma.style.display = tipo === 'Aula' ? 'block' : 'none';
            selectTurma.required = tipo === 'Aula';
            
            if (tipo === 'Aula') {
                selectTurma.innerHTML = '<option value="">Selecione...</option>' + 
                    data.turmas.map(t => `<option value="${t.id}">${t.nome} (${t.disciplina})</option>`).join('');
            }
        }

        function toggleRecorrenciaUI() {
            const tipo = document.getElementById('eventoRecorrenciaTipo').value;
            const div = document.getElementById('divRecorrenciaFim');
            const divPers = document.getElementById('divRecorrenciaPersonalizada');
            const input = document.getElementById('eventoRecorrenciaFim');
            
            const temRecorrencia = tipo !== 'nao';
            div.style.display = temRecorrencia ? 'block' : 'none';
            input.required = temRecorrencia;
            
            divPers.style.display = tipo === 'personalizado' ? 'block' : 'none';
        }

        function salvarEvento(e) {
            e.preventDefault();

            const tipo = document.getElementById('eventoTipo').value;
            let titulo = document.getElementById('eventoTitulo').value;
            const dataInicio = document.getElementById('eventoData').value;
            const anotacoes = document.getElementById('eventoAnotacoes').value;
            const horaInicio = document.getElementById('eventoHoraInicio').value;
            const horaFim = document.getElementById('eventoHoraFim').value;
            
            const recorrenciaTipo = document.getElementById('eventoRecorrenciaTipo').value;
            const dataFimRecorrencia = document.getElementById('eventoRecorrenciaFim').value;

            let idTurma = null;
            let turmaNome = null;

            if (tipo === 'Aula') {
                idTurma = parseInt(document.getElementById('eventoTurmaSelect').value);
                const turma = data.turmas.find(t => t.id === idTurma);
                turmaNome = turma ? `${turma.nome} - ${turma.disciplina}` : '';
                titulo = `Aula: ${turma.disciplina} (${turma.nome})`; // Sobrescreve t√≠tulo visual
            }

            if (recorrenciaTipo !== 'nao' && dataFimRecorrencia) {
                // Usar T12:00:00 para evitar problemas de fuso hor√°rio
                let dataAtual = new Date(dataInicio + 'T12:00:00');
                const dataFim = new Date(dataFimRecorrencia + 'T12:00:00');

                const criarEvento = (dataStr) => ({
                        id: getNextId(data.eventos),
                        tipo: tipo,
                        id_turma: idTurma,
                        turma_nome: turmaNome,
                        data: dataStr,
                        hora_inicio: horaInicio,
                        hora_fim: horaFim,
                        descricao: titulo,
                        anotacoes: anotacoes
                });

                if (recorrenciaTipo === 'semanal') {
                    while (dataAtual <= dataFim) {
                        data.eventos.push(criarEvento(dataAtual.toISOString().split('T')[0]));
                        dataAtual.setDate(dataAtual.getDate() + 7);
                    }
                } else if (recorrenciaTipo === 'mensal') {
                    let mesesAdicionados = 0;
                    while (true) {
                        let proximaData = new Date(dataInicio + 'T12:00:00');
                        proximaData.setMonth(proximaData.getMonth() + mesesAdicionados);
                        
                        if (proximaData > dataFim) break;
                        
                        data.eventos.push(criarEvento(proximaData.toISOString().split('T')[0]));
                        mesesAdicionados++;
                    }
                } else if (recorrenciaTipo === 'personalizado') {
                    const checkboxes = document.querySelectorAll('input[name="diaSemana"]:checked');
                    const diasSelecionados = Array.from(checkboxes).map(cb => parseInt(cb.value));
                    
                    if (diasSelecionados.length === 0) {
                        alert('Selecione pelo menos um dia da semana para a recorr√™ncia personalizada.');
                        return;
                    }

                    while (dataAtual <= dataFim) {
                        if (diasSelecionados.includes(dataAtual.getDay())) {
                            data.eventos.push(criarEvento(dataAtual.toISOString().split('T')[0]));
                        }
                        dataAtual.setDate(dataAtual.getDate() + 1);
                    }
                }
            } else {
                data.eventos.push({
                    id: getNextId(data.eventos),
                    tipo: tipo,
                    id_turma: idTurma,
                    turma_nome: turmaNome,
                    data: dataInicio,
                    hora_inicio: horaInicio,
                    hora_fim: horaFim,
                    descricao: titulo,
                    anotacoes: anotacoes
                });
            }

            persistirDados();
            closeModal('modalNovoEvento');
            renderAgenda();
            e.target.reset();
            toggleRecorrenciaUI();
        }

        function abrirDetalhesEvento(id) {
            const evento = data.eventos.find(e => e.id == id);
            if (!evento) return;

            document.getElementById('detalheEventoId').value = evento.id;
            document.getElementById('detalheEventoTipo').value = evento.tipo;
            document.getElementById('detalheEventoData').value = evento.data;
            document.getElementById('detalheEventoInicio').value = evento.hora_inicio;
            document.getElementById('detalheEventoFim').value = evento.hora_fim;
            document.getElementById('detalheEventoTitulo').value = evento.descricao;
            document.getElementById('detalheEventoAnotacoes').value = evento.anotacoes || '';

            showModal('modalDetalhesEvento');
        }

        function salvarDetalhesEvento(e) {
            e.preventDefault();
            const id = document.getElementById('detalheEventoId').value;
            const evento = data.eventos.find(e => e.id == id);
            
            if (evento) {
                evento.data = document.getElementById('detalheEventoData').value;
                evento.hora_inicio = document.getElementById('detalheEventoInicio').value;
                evento.hora_fim = document.getElementById('detalheEventoFim').value;
                evento.descricao = document.getElementById('detalheEventoTitulo').value;
                evento.anotacoes = document.getElementById('detalheEventoAnotacoes').value;
                
                renderAgenda();
                persistirDados();
                closeModal('modalDetalhesEvento');
            }
        }

        function excluirEventoAtual() {
            const id = document.getElementById('detalheEventoId').value;
            removerEvento(id);
            closeModal('modalDetalhesEvento');
        }

        // OCORR√äNCIAS
        window.estudantesOcorrenciaIds = [];

        function renderOcorrencias() {
            window.estudantesOcorrenciaIds = []; // Resetar lista ao abrir
            const estudantes = getEstudantesDaTurma(turmaAtual).filter(e => !e.status || e.status === 'Ativo')
                .sort((a, b) => a.numero_chamada - b.numero_chamada);

            const ocorrenciasTurma = data.ocorrencias
                .filter(o => o.id_turma === turmaAtual)
                .sort((a, b) => new Date(b.data) - new Date(a.data));

            const html = `
                <div style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%); color: #5d2e46; padding: 25px; border-radius: 8px; margin-bottom: 25px;">
                    <h3 style="color: #5d2e46; margin: 0 0 10px 0; border: none; padding: 0;">‚ö†Ô∏è Registro de Ocorr√™ncias</h3>
                    <p style="margin: 0; font-size: 14px; opacity: 0.95;">
                        Registre incidentes, comportamentos ou observa√ß√µes importantes e gere relat√≥rios para a gest√£o.
                    </p>
                </div>

                <div class="card" style="margin-bottom: 20px; background: #f7fafc;">
                    <h4>üîç Filtrar Ocorr√™ncias</h4>
                    <div class="form-row">
                        <label>
                            Nome do Estudante:
                            <input type="text" id="filtroOcorrenciaNome" onkeyup="filtrarOcorrenciasUI()" placeholder="Digite para buscar...">
                        </label>
                        <label>
                            Data:
                            <input type="date" id="filtroOcorrenciaData" onchange="filtrarOcorrenciasUI()">
                        </label>
                    </div>
                </div>

                <div class="card" style="border: 2px solid #e2e8f0; box-shadow: none;">
                    <h4 style="margin-top: 0;">Nova Ocorr√™ncia</h4>
                    <form onsubmit="salvarOcorrencia(event)">
                        <div class="form-row">
                            <label>
                                üìÖ Data:
                                <input type="date" id="ocorrenciaData" value="${getTodayString()}" required>
                            </label>
                        </div>
                        
                        <label>
                            üë• Estudantes Envolvidos:
                            <div style="display: flex; gap: 10px;">
                                <select id="selectEstudanteOcorrencia" style="flex: 1;">
                                    <option value="">Selecione um estudante...</option>
                                    ${estudantes.map(e => `<option value="${e.id}">${e.numero_chamada} - ${e.nome_completo}</option>`).join('')}
                                </select>
                                <button type="button" class="btn btn-secondary" onclick="adicionarEstudanteOcorrencia()" style="margin-top: 5px;">Adicionar</button>
                            </div>
                        </label>

                        <div id="listaEstudantesSelecionados" style="margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 8px; min-height: 30px; padding: 10px; background: #f7fafc; border-radius: 6px; border: 1px solid #e2e8f0;">
                            <span style="color: #718096; font-size: 13px;">Nenhum estudante selecionado</span>
                        </div>

                        <label style="margin-top: 15px;">
                            üìù Relato da Ocorr√™ncia:
                            <textarea id="ocorrenciaRelato" rows="5" required placeholder="Descreva detalhadamente o ocorrido..."></textarea>
                        </label>

                        <button type="submit" class="btn btn-primary">Salvar Ocorr√™ncia</button>
                    </form>
                </div>

                <div style="margin-top: 30px;">
                    <h4>üìú Hist√≥rico de Ocorr√™ncias</h4>
                    <div id="listaOcorrenciasContainer">
                        ${renderTabelaOcorrencias(ocorrenciasTurma)}
                    </div>
                </div>
            `;

            document.getElementById('tabOcorrencias').innerHTML = html;
        }

        function renderTabelaOcorrencias(lista) {
            if (lista.length === 0) return '<p class="empty-state">Nenhuma ocorr√™ncia encontrada.</p>';
            
            return `
                        <table>
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Estudantes</th>
                                    <th>Relato (Resumo)</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${lista.map(o => {
                                    const nomesEstudantes = o.ids_estudantes.map(id => {
                                        const est = getEstudanteById(id);
                                        return est ? est.nome_completo.split(' ')[0] : '?';
                                    }).join(', ');
                                    
                                    return `
                                        <tr>
                                            <td>${formatDate(o.data)}</td>
                                            <td>${nomesEstudantes}</td>
                                            <td title="${o.relato}">${o.relato.length > 50 ? o.relato.substring(0, 50) + '...' : o.relato}</td>
                                            <td>
                                                <button class="btn btn-secondary btn-sm" onclick="imprimirOcorrencia(${o.id})">üñ®Ô∏è PDF</button>
                                                <button class="btn btn-danger btn-sm" onclick="removerOcorrencia(${o.id})">üóëÔ∏è</button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
            `;
        }

        function filtrarOcorrenciasUI() {
            const termo = document.getElementById('filtroOcorrenciaNome').value.toLowerCase();
            const dataFiltro = document.getElementById('filtroOcorrenciaData').value;

            let filtradas = data.ocorrencias.filter(o => o.id_turma === turmaAtual);

            if (dataFiltro) {
                filtradas = filtradas.filter(o => o.data === dataFiltro);
            }

            if (termo) {
                filtradas = filtradas.filter(o => {
                    const nomes = o.ids_estudantes.map(id => {
                        const e = getEstudanteById(id);
                        return e ? e.nome_completo.toLowerCase() : '';
                    }).join(' ');
                    return nomes.includes(termo);
                });
            }

            filtradas.sort((a, b) => new Date(b.data) - new Date(a.data));
            document.getElementById('listaOcorrenciasContainer').innerHTML = renderTabelaOcorrencias(filtradas);
        }

        function adicionarEstudanteOcorrencia() {
            const select = document.getElementById('selectEstudanteOcorrencia');
            const id = parseInt(select.value);
            if (!id) return;

            if (window.estudantesOcorrenciaIds.includes(id)) {
                alert('Estudante j√° selecionado!');
                return;
            }

            window.estudantesOcorrenciaIds.push(id);
            renderListaEstudantesOcorrencia();
            select.value = "";
        }

        function removerEstudanteOcorrencia(id) {
            window.estudantesOcorrenciaIds = window.estudantesOcorrenciaIds.filter(i => i !== id);
            renderListaEstudantesOcorrencia();
        }

        function renderListaEstudantesOcorrencia() {
            const container = document.getElementById('listaEstudantesSelecionados');
            if (window.estudantesOcorrenciaIds.length === 0) {
                container.innerHTML = '<span style="color: #718096; font-size: 13px;">Nenhum estudante selecionado</span>';
                return;
            }

            container.innerHTML = window.estudantesOcorrenciaIds.map(id => {
                const est = getEstudanteById(id);
                return `
                    <div style="background: #ebf8ff; color: #2c5282; padding: 5px 10px; border-radius: 15px; font-size: 13px; display: flex; align-items: center; gap: 5px; border: 1px solid #bee3f8;">
                        ${est.numero_chamada} - ${est.nome_completo.split(' ')[0]}
                        <span onclick="removerEstudanteOcorrencia(${id})" style="cursor: pointer; font-weight: bold; margin-left: 5px; color: #2c5282;">√ó</span>
                    </div>
                `;
            }).join('');
        }

        function salvarOcorrencia(e) {
            e.preventDefault();
            
            if (window.estudantesOcorrenciaIds.length === 0) {
                alert('Selecione pelo menos um estudante envolvido.');
                return;
            }

            const novaOcorrencia = {
                id: getNextId(data.ocorrencias),
                id_turma: turmaAtual,
                data: document.getElementById('ocorrenciaData').value,
                ids_estudantes: [...window.estudantesOcorrenciaIds],
                relato: document.getElementById('ocorrenciaRelato').value
            };

            data.ocorrencias.push(novaOcorrencia);
            persistirDados();
            renderOcorrencias();
            alert('Ocorr√™ncia registrada com sucesso!');
        }

        function removerOcorrencia(id) {
            if(confirm('Tem certeza que deseja excluir esta ocorr√™ncia?')) {
                data.ocorrencias = data.ocorrencias.filter(o => o.id !== id);
                persistirDados();
                renderOcorrencias();
            }
        }

        function imprimirOcorrencia(id) {
            const ocorrencia = data.ocorrencias.find(o => o.id === id);
            if (!ocorrencia) return;

            const turma = data.turmas.find(t => t.id === ocorrencia.id_turma);
            if (!turma) {
                alert('Erro: Turma n√£o encontrada para esta ocorr√™ncia.');
                return;
            }

            const estudantes = ocorrencia.ids_estudantes.map(id => {
                const est = getEstudanteById(id);
                return est ? `${est.numero_chamada} - ${est.nome_completo}` : '';
            }).filter(n => n);

            const html = `
                <div style="font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto;">
                    <div style="text-align: center; margin-bottom: 40px; border-bottom: 2px solid #333; padding-bottom: 20px;">
                        <h2 style="margin: 0;">REGISTRO DE OCORR√äNCIA ESCOLAR</h2>
                        <p style="margin: 5px 0 0 0;">Sistema de Gest√£o Escolar</p>
                    </div>

                    <div style="background: #f9f9f9; padding: 15px; border: 1px solid #ddd; margin-bottom: 20px;">
                        <p style="margin: 5px 0;"><span style="font-weight: bold; color: #555;">Data:</span> ${formatDate(ocorrencia.data)}</p>
                        <p style="margin: 5px 0;"><span style="font-weight: bold; color: #555;">Turma:</span> ${turma.nome} (${turma.ano_serie})</p>
                        <p style="margin: 5px 0;"><span style="font-weight: bold; color: #555;">Disciplina:</span> ${turma.disciplina}</p>
                        <p style="margin: 5px 0;"><span style="font-weight: bold; color: #555;">Estudantes Envolvidos:</span></p>
                        <ul style="margin: 5px 0; padding-left: 20px;">
                            ${estudantes.map(e => `<li>${e}</li>`).join('')}
                        </ul>
                    </div>

                    <h3 style="margin-top: 30px;">Relato do Ocorrido:</h3>
                    <div style="line-height: 1.6; text-align: justify; margin-bottom: 50px; white-space: pre-wrap;">${ocorrencia.relato || ''}</div>

                    <div style="margin-top: 80px; display: flex; justify-content: space-between;">
                        <div style="border-top: 1px solid #000; width: 45%; text-align: center; padding-top: 10px;">Professor(a) Respons√°vel</div>
                        <div style="border-top: 1px solid #000; width: 45%; text-align: center; padding-top: 10px;">Coordena√ß√£o Pedag√≥gica</div>
                    </div>
                    
                    <div style="margin-top: 60px;">
                        <div style="border-top: 1px solid #000; width: 100%; text-align: center; padding-top: 10px;">Ciente (Respons√°vel/Estudante)</div>
                    </div>
                </div>
            `;

            document.getElementById('conteudoRelatorio').innerHTML = html;
            showScreen('relatorioImpressao');
        }

        // VIS√ÉO GERAL DO ESTUDANTE
        function abrirVisaoGeralEstudante(id) {
            const estudante = getEstudanteById(id);
            if (!estudante) return;
            const isGestor = currentUser && currentUser.role === 'gestor';

            const turma = data.turmas.find(t => t.id === estudante.id_turma);
            
            document.getElementById('estudanteGeralNome').textContent = `${estudante.numero_chamada} - ${estudante.nome_completo}`;

            // 1. Frequ√™ncia
            const aulasTurma = data.aulas.filter(a => a.id_turma === turma.id);
            const totalAulas = aulasTurma.length;
            const faltas = data.presencas.filter(p => p.id_estudante === id && p.status === 'falta').length;
            const presencaPerc = totalAulas > 0 ? ((totalAulas - faltas) / totalAulas * 100).toFixed(1) : 100;
            
            document.getElementById('estudanteGeralFrequencia').innerHTML = isGestor ? '<p style="color:#718096">Vis√£o restrita ao professor.</p>' : `
                <div onclick="mostrarRelatorioFaltas(${id})" style="text-align: center; padding: 10px; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'" title="Clique para ver detalhes das faltas">
                    <div style="font-size: 36px; font-weight: bold; color: ${presencaPerc < 75 ? '#e53e3e' : '#38a169'};">
                        ${presencaPerc}%
                    </div>
                    <div style="font-size: 14px; color: #718096;">Presen√ßa Global</div>
                    <div style="margin-top: 10px; font-size: 13px;">
                        <strong>${faltas}</strong> faltas em <strong>${totalAulas}</strong> aulas
                    </div>
                    <div style="margin-top: 5px; font-size: 11px; color: #3182ce; text-decoration: underline;">Ver relat√≥rio de faltas</div>
                </div>
            `;

            // 2. Atrasos
            const atrasos = data.atrasos.filter(a => a.id_estudante === id);
            document.getElementById('estudanteGeralAtrasos').innerHTML = `
                <div style="text-align: center; padding: 10px;">
                    <div style="font-size: 36px; font-weight: bold; color: #c53030;">
                        ${atrasos.length}
                    </div>
                    <div style="font-size: 14px; color: #718096;">Total de Atrasos</div>
                    ${atrasos.length > 0 ? `
                        <div style="margin-top: 15px; text-align: left; max-height: 100px; overflow-y: auto; font-size: 12px;">
                            ${atrasos.map(a => `<div>üìÖ ${formatDate(a.data)}</div>`).join('')}
                        </div>
                    ` : ''}
                </div>
            `;

            // 3. Notas
            const trabalhos = data.trabalhos.filter(t => t.id_turma === turma.id);
            const htmlNotas = isGestor ? '<p style="color:#718096">Vis√£o restrita ao professor.</p>' : (trabalhos.length > 0 ? `
                <table style="font-size: 13px;">
                    <thead>
                        <tr>
                            <th>Trabalho</th>
                            <th>Peso</th>
                            <th>Nota</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${trabalhos.map(t => {
                            const nota = data.notas.find(n => n.id_trabalho === t.id && n.id_estudante === id);
                            const valor = nota ? parseFloat(nota.valor) : null;
                            const cor = valor !== null ? (valor >= 6 ? '#22c55e' : '#ef4444') : '#718096';
                            return `
                                <tr>
                                    <td>${t.titulo}</td>
                                    <td>${t.peso}</td>
                                    <td style="font-weight: bold; color: ${cor};">
                                        ${valor !== null ? valor.toFixed(1) : '-'}
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            ` : '<p class="empty-state" style="font-size: 13px;">Nenhum trabalho registrado</p>');
            document.getElementById('estudanteGeralNotas').innerHTML = htmlNotas;

            // 4. Ocorr√™ncias
            const ocorrencias = data.ocorrencias.filter(o => o.ids_estudantes.includes(id));
            const htmlOcorrencias = ocorrencias.length > 0 ? `
                <ul style="list-style: none; padding: 0;">
                    ${ocorrencias.map(o => `
                        <li style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #eee;">
                            <div style="font-size: 12px; color: #718096;">üìÖ ${formatDate(o.data)}</div>
                            <div style="font-size: 13px; margin-top: 2px;">${o.relato}</div>
                        </li>
                    `).join('')}
                </ul>
            ` : '<p class="empty-state" style="font-size: 13px;">Nenhuma ocorr√™ncia</p>';
            document.getElementById('estudanteGeralOcorrencias').innerHTML = htmlOcorrencias;

            // 5. Compensa√ß√µes
            const compensacoes = data.compensacoes.filter(c => c.id_estudante === id);
            const htmlComp = isGestor ? '<p style="color:#718096">Vis√£o restrita ao professor.</p>' : (compensacoes.length > 0 ? `
                <table style="font-size: 13px;">
                    <thead>
                        <tr>
                            <th>Descri√ß√£o</th>
                            <th>Prazo</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${compensacoes.map(c => `
                            <tr>
                                <td>${c.descricao}</td>
                                <td>${formatDate(c.data_entrega)}</td>
                                <td>
                                    <span class="badge" style="background: ${getStatusColor(c.status)}; color: white;">
                                        ${c.status.replace('_', ' ')}
                                    </span>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : '<p class="empty-state" style="font-size: 13px;">Nenhuma compensa√ß√£o atribu√≠da</p>');
            document.getElementById('estudanteGeralCompensacoes').innerHTML = htmlComp;

            showScreen('estudanteDetalhe');
        }

        function mostrarRelatorioFaltas(id) {
            const estudante = getEstudanteById(id);
            const faltas = data.presencas.filter(p => p.id_estudante === id && p.status === 'falta');
            
            let html = `
                <div style="margin-bottom: 20px; background: #fff5f5; padding: 15px; border-radius: 6px; border-left: 4px solid #e53e3e;">
                    <h3 style="margin: 0 0 5px 0; color: #c53030;">${estudante.nome_completo}</h3>
                    <div>Total de Faltas: <strong>${faltas.length}</strong></div>
                </div>
            `;

            if (faltas.length > 0) {
                // Buscar detalhes das aulas
                const faltasDetalhadas = faltas.map(f => {
                    const aula = data.aulas.find(a => a.id === f.id_aula);
                    return { data: aula ? aula.data : '?', conteudo: aula ? aula.conteudo : '-' };
                }).sort((a, b) => new Date(b.data) - new Date(a.data));

                html += `
                    <table style="width: 100%;">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Conte√∫do Ministrado</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${faltasDetalhadas.map(f => `
                                <tr>
                                    <td>${formatDate(f.data)}</td>
                                    <td>${f.conteudo || '<span style="color:#718096; font-style:italic;">Sem conte√∫do registrado</span>'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                html += '<p class="empty-state">Este estudante n√£o possui faltas registradas.</p>';
            }

            document.getElementById('conteudoRelatorioFaltas').innerHTML = html;
            showModal('modalRelatorioFaltas');
        }

        // --- FUNCIONALIDADES GESTOR ---

        function renderRegistrosGestor() {
            const registros = data.registrosAdministrativos || [];
            const today = new Date();

            // Filtrar e processar
            const lista = registros.map(r => {
                const estudante = getEstudanteById(r.estudanteId); // Gestor usa local, mas getEstudanteById trata isso
                const turma = data.turmas.find(t => t.id === r.turmaId);
                
                let status = 'Ativo';
                let cor = '#22c55e'; // Verde

                if (r.tipo === 'Atestado') {
                    const dataInicio = new Date(r.data);
                    const dataFim = new Date(dataInicio);
                    dataFim.setDate(dataFim.getDate() + parseInt(r.dias));
                    
                    if (today > dataFim) {
                        status = 'Vencido';
                        cor = '#718096'; // Cinza
                    }
                } else if (r.tipo === 'Faltoso') {
                    cor = '#ef4444'; // Vermelho
                }

                return { ...r, estudanteNome: estudante?.nome_completo, turmaNome: turma?.nome, status, cor };
            }).filter(r => r.status === 'Ativo' || r.tipo === 'Faltoso'); // Mostrar apenas ativos ou faltosos

            // Agrupar por turma
            const porTurma = {};
            lista.forEach(r => {
                if (!porTurma[r.turmaNome]) porTurma[r.turmaNome] = [];
                porTurma[r.turmaNome].push(r);
            });

            const html = `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2>üìÇ Registros Administrativos</h2>
                        <button class="btn btn-primary" onclick="abrirNovoRegistroGestao()">+ Novo Registro</button>
                    </div>
                    <div style="margin-top: 20px;">
                        <div style="display: flex; justify-content: flex-end; margin-bottom: 10px;">
                            <button class="btn btn-secondary btn-sm" onclick="abrirLinkPublicoRegistros()">üîó Link P√∫blico (Impress√£o)</button>
                        </div>
                        ${Object.keys(porTurma).length > 0 ? Object.keys(porTurma).map(turma => `
                            <div style="margin-bottom: 20px; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden;">
                                <div style="background: #f7fafc; padding: 10px; font-weight: bold; border-bottom: 1px solid #e2e8f0;">${turma}</div>
                                <table style="margin: 0;">
                                    <tbody>
                                        ${porTurma[turma].map(r => `
                                            <tr style="background: ${r.tipo === 'Faltoso' ? '#fff5f5' : 'white'};">
                                                <td style="color: ${r.cor}; font-weight: bold;">${r.tipo}</td>
                                                <td>${r.estudanteNome}</td>
                                                <td>${formatDate(r.data)} ${r.tipo === 'Atestado' ? `(${r.dias} dias)` : ''}</td>
                                                <td>
                                                    <button class="btn btn-danger btn-sm" onclick="removerRegistroGestao(${r.id})">üóëÔ∏è</button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `).join('') : '<p class="empty-state">Nenhum registro ativo.</p>'}
                    </div>
                </div>
            `;
            document.getElementById('registrosGestor').innerHTML = html;
        }

        function abrirNovoRegistroGestao() {
            const turmas = data.turmas;
            const html = `
                <form onsubmit="salvarRegistroGestao(event)">
                    <label>
                        Turma:
                        <select id="regGestaoTurma" onchange="carregarEstudantesRegGestao()" required>
                            <option value="">Selecione...</option>
                            ${turmas.map(t => `<option value="${t.id}">${t.nome}</option>`).join('')}
                        </select>
                    </label>
                    <label>
                        Estudante:
                        <div style="display: flex; gap: 5px;">
                            <select id="regGestaoEstudante" required disabled>
                                <option value="">Selecione a turma primeiro...</option>
                            </select>
                            <button type="button" class="btn btn-secondary" onclick="criarEstudanteRapidoGestao()">+</button>
                        </div>
                    </label>
                    <label>
                        Tipo:
                        <select id="regGestaoTipo" onchange="toggleDiasAtestado()" required>
                            <option value="Atestado">Atestado M√©dico</option>
                            <option value="Faltoso">Aluno Faltoso</option>
                        </select>
                    </label>
                    <label>
                        Data In√≠cio:
                        <input type="date" id="regGestaoData" value="${getTodayString()}" required>
                    </label>
                    <div id="divDiasAtestado">
                        <label>
                            Dura√ß√£o (dias):
                            <input type="number" id="regGestaoDias" value="1" min="1">
                        </label>
                    </div>
                    <button type="submit" class="btn btn-primary" style="margin-top: 15px;">Salvar</button>
                </form>
            `;
            document.getElementById('formRegistroGestaoConteudo').innerHTML = html;
            showModal('modalNovoRegistroGestao');
        }

        function carregarEstudantesRegGestao() {
            const turmaId = document.getElementById('regGestaoTurma').value;
            const select = document.getElementById('regGestaoEstudante');
            
            if (!turmaId) {
                select.innerHTML = '<option value="">Selecione a turma primeiro...</option>';
                select.disabled = true;
                return;
            }

            const estudantes = data.estudantes.filter(e => e.id_turma == turmaId);
            select.innerHTML = `<option value="">Selecione...</option>` + 
                estudantes.map(e => `<option value="${e.id}">${e.nome_completo}</option>`).join('');
            select.disabled = false;
        }

        function toggleDiasAtestado() {
            const tipo = document.getElementById('regGestaoTipo').value;
            document.getElementById('divDiasAtestado').style.display = tipo === 'Atestado' ? 'block' : 'none';
        }

        function criarEstudanteRapidoGestao() {
            const turmaId = document.getElementById('regGestaoTurma').value;
            if (!turmaId) {
                alert('Selecione a turma primeiro.');
                return;
            }
            const nome = prompt('Nome do novo estudante:');
            if (nome) {
                const novoId = getNextId(data.estudantes);
                data.estudantes.push({
                    id: novoId,
                    id_turma: parseInt(turmaId),
                    nome_completo: nome,
                    numero_chamada: 99, // Tempor√°rio
                    status: 'Ativo'
                });
                persistirDados();
                carregarEstudantesRegGestao();
                // Selecionar o rec√©m criado
                setTimeout(() => document.getElementById('regGestaoEstudante').value = novoId, 100);
            }
        }

        function salvarRegistroGestao(e) {
            e.preventDefault();
            const novo = {
                id: Date.now(),
                turmaId: parseInt(document.getElementById('regGestaoTurma').value),
                estudanteId: parseInt(document.getElementById('regGestaoEstudante').value),
                tipo: document.getElementById('regGestaoTipo').value,
                data: document.getElementById('regGestaoData').value,
                dias: document.getElementById('regGestaoDias').value || 0
            };
            
            if (!data.registrosAdministrativos) data.registrosAdministrativos = [];
            data.registrosAdministrativos.push(novo);
            persistirDados();
            closeModal('modalNovoRegistroGestao');
            renderRegistrosGestor();
        }

        function removerRegistroGestao(id) {
            if (confirm('Excluir este registro?')) {
                data.registrosAdministrativos = data.registrosAdministrativos.filter(r => r.id !== id);
                persistirDados();
                renderRegistrosGestor();
            }
        }

        function abrirLinkPublicoRegistros() {
            const conteudo = document.getElementById('registrosGestor').innerHTML;
            const win = window.open('', '_blank');
            win.document.write(`
                <html>
                <head>
                    <title>Relat√≥rio P√∫blico</title>
                    <style>
                        body { font-family: sans-serif; padding: 20px; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        .btn { display: none; } /* Esconder bot√µes */
                    </style>
                </head>
                <body>
                    <h1>Relat√≥rio de Faltas e Atestados Vigentes</h1>
                    ${conteudo}
                    <script>
                        // Remover bot√µes de a√ß√£o do HTML injetado
                        document.querySelectorAll('button').forEach(b => b.remove());
                    <\/script>
                </body>
                </html>
            `);
        }

        function renderOcorrenciasGestor() {
            // Agrupar ocorr√™ncias por turma
            const ocorrencias = data.ocorrencias.sort((a, b) => new Date(b.data) - new Date(a.data));
            
            const html = `
                <div class="card">
                    <h2>‚ö†Ô∏è Ocorr√™ncias da Escola</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Turma</th>
                                <th>Relato</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${ocorrencias.map(o => {
                                const turma = data.turmas.find(t => t.id === o.id_turma);
                                return `
                                    <tr>
                                        <td>${formatDate(o.data)}</td>
                                        <td>${turma ? turma.nome : '?'}</td>
                                        <td>${o.relato}</td>
                                        <td>
                                            <label style="cursor: pointer;">
                                                <input type="checkbox" ${o.visto_gestao ? 'checked' : ''} onchange="toggleVistoOcorrencia(${o.id}, this.checked)">
                                                Visualizado
                                            </label>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            document.getElementById('ocorrenciasGestor').innerHTML = html;
        }

        function toggleVistoOcorrencia(id, checked) {
            const oco = data.ocorrencias.find(o => o.id === id);
            if (oco) {
                oco.visto_gestao = checked;
                persistirDados();
            }
        }

        function renderHorariosGestor() {
            const grade = data.gradeHoraria || [];
            const diasSemana = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
            
            const html = `
                <div class="card">
                    <h2>‚è∞ Grade de Hor√°rios da Escola</h2>
                    <p>Defina os hor√°rios de in√≠cio e fim das aulas, intervalos e almo√ßo. Esta estrutura servir√° de base para os professores.</p>
                    
                    <div style="background: #f7fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #e2e8f0;">
                        <h4>‚ûï Adicionar Per√≠odo/Aula</h4>
                        <form onsubmit="adicionarItemGrade(event)">
                            <div class="form-row">
                                <label>
                                    Nome (ex: 1¬™ Aula, Intervalo):
                                    <input type="text" id="gradeNome" required>
                                </label>
                                <label>
                                    In√≠cio:
                                    <input type="time" id="gradeInicio" required>
                                </label>
                                <label>
                                    Fim:
                                    <input type="time" id="gradeFim" required>
                                </label>
                            </div>
                            <label>Dias da Semana:</label>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
                                ${diasSemana.map((d, i) => i > 0 ? `
                                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                        <input type="checkbox" name="gradeDias" value="${i}" checked> ${d}
                                    </label>
                                ` : '').join('')}
                            </div>
                            <button type="submit" class="btn btn-primary">Adicionar √† Grade</button>
                        </form>
                    </div>

                    <h3>üìã Grade Definida</h3>
                    ${grade.length > 0 ? `
                        <table>
                            <thead>
                                <tr>
                                    <th>Per√≠odo</th>
                                    <th>Hor√°rio</th>
                                    <th>Dias</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${grade.sort((a,b) => a.inicio.localeCompare(b.inicio)).map(g => `
                                    <tr>
                                        <td><strong>${g.nome}</strong></td>
                                        <td>${g.inicio} - ${g.fim}</td>
                                        <td>${g.dias.map(d => diasSemana[d].substring(0,3)).join(', ')}</td>
                                        <td><button class="btn btn-danger btn-sm" onclick="removerItemGrade(${g.id})">üóëÔ∏è</button></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    ` : '<p class="empty-state">Nenhum hor√°rio definido.</p>'}
                </div>
            `;
            document.getElementById('horariosGestor').innerHTML = html;
        }

        function adicionarItemGrade(e) {
            e.preventDefault();
            const nome = document.getElementById('gradeNome').value;
            const inicio = document.getElementById('gradeInicio').value;
            const fim = document.getElementById('gradeFim').value;
            
            const checkboxes = document.querySelectorAll('input[name="gradeDias"]:checked');
            const dias = Array.from(checkboxes).map(cb => parseInt(cb.value));

            if (dias.length === 0) {
                alert('Selecione pelo menos um dia da semana.');
                return;
            }

            if (!data.gradeHoraria) data.gradeHoraria = [];
            
            data.gradeHoraria.push({
                id: Date.now(),
                nome,
                inicio,
                fim,
                dias
            });
            
            persistirDados();
            renderHorariosGestor();
            e.target.reset();
        }

        function removerItemGrade(id) {
            if (confirm('Remover este item da grade?')) {
                data.gradeHoraria = data.gradeHoraria.filter(g => g.id !== id);
                persistirDados();
                renderHorariosGestor();
            }
        }

        // Sobrescrever renderConfiguracoes para n√£o depender do ID fixo se chamado pelo gestor?
        // N√£o, o renderConfiguracoes usa document.getElementById('tabConfiguracoes').
        // O hack acima funciona porque criamos o elemento temporariamente.

        // --- L√ìGICA DO SUPER ADMIN ---
        let escolaAtualAdmin = null;

        function iniciarAdmin() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('appContainer').style.display = 'none';
            document.getElementById('adminContainer').style.display = 'block';
            renderAdminEscolas();
        }

        function getEscolas() {
            return JSON.parse(localStorage.getItem('app_schools') || '[]');
        }

        function saveEscolas(escolas) {
            localStorage.setItem('app_schools', JSON.stringify(escolas));
        }

        function renderAdminEscolas() {
            const escolas = getEscolas();
            document.getElementById('adminEscolasScreen').style.display = 'block';
            document.getElementById('adminEscolaDetalheScreen').style.display = 'none';

            const html = escolas.length > 0 ? `
                <table>
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Endere√ßo</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${escolas.map(e => `
                            <tr>
                                <td><strong>${e.nome}</strong></td>
                                <td>${e.endereco || '-'}</td>
                                <td>
                                    <button class="btn btn-info btn-sm" onclick="verUsuariosEscola(${e.id})">üë• Usu√°rios</button>
                                    <button class="btn btn-secondary btn-sm" onclick="editarEscola(${e.id})">‚úèÔ∏è</button>
                                    <button class="btn btn-danger btn-sm" onclick="excluirEscola(${e.id})">üóëÔ∏è</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : '<p class="empty-state">Nenhuma escola cadastrada.</p>';

            document.getElementById('listaEscolasAdmin').innerHTML = html;
        }

        function abrirModalEscola() {
            document.getElementById('adminEscolaId').value = '';
            document.getElementById('adminEscolaNome').value = '';
            document.getElementById('adminEscolaEndereco').value = '';
            document.getElementById('tituloModalEscola').textContent = 'Nova Escola';
            showModal('modalAdminEscola');
        }

        function editarEscola(id) {
            const escolas = getEscolas();
            const escola = escolas.find(e => e.id === id);
            if (escola) {
                document.getElementById('adminEscolaId').value = escola.id;
                document.getElementById('adminEscolaNome').value = escola.nome;
                document.getElementById('adminEscolaEndereco').value = escola.endereco || '';
                document.getElementById('tituloModalEscola').textContent = 'Editar Escola';
                showModal('modalAdminEscola');
            }
        }

        function salvarEscola(e) {
            e.preventDefault();
            const id = document.getElementById('adminEscolaId').value;
            const nome = document.getElementById('adminEscolaNome').value;
            const endereco = document.getElementById('adminEscolaEndereco').value;
            let escolas = getEscolas();

            if (id) {
                const escola = escolas.find(e => e.id == id);
                if (escola) {
                    escola.nome = nome;
                    escola.endereco = endereco;
                }
            } else {
                escolas.push({ id: Date.now(), nome, endereco });
            }
            saveEscolas(escolas);
            closeModal('modalAdminEscola');
            renderAdminEscolas();
        }

        function excluirEscola(id) {
            if (confirm('Tem certeza? Isso n√£o excluir√° os usu√°rios, mas eles ficar√£o sem escola.')) {
                let escolas = getEscolas();
                escolas = escolas.filter(e => e.id !== id);
                saveEscolas(escolas);
                renderAdminEscolas();
            }
        }

        function verUsuariosEscola(escolaId) {
            escolaAtualAdmin = escolaId;
            const escolas = getEscolas();
            const escola = escolas.find(e => e.id === escolaId);
            
            document.getElementById('adminEscolasScreen').style.display = 'none';
            document.getElementById('adminEscolaDetalheScreen').style.display = 'block';
            
            const container = document.getElementById('adminEscolaDetalheScreen');
            container.innerHTML = `
                <div class="card">
                    <button class="btn btn-secondary" onclick="renderAdminEscolas()">‚Üê Voltar para Escolas</button>
                    <h2 style="margin-top: 15px;">Escola: ${escola.nome}</h2>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0;">
                        <h3>üë• Usu√°rios Cadastrados</h3>
                        <button class="btn btn-primary" onclick="abrirModalUsuarioAdmin()">+ Novo Usu√°rio</button>
                    </div>
                    <div id="listaUsuariosEscolaAdmin"></div>
                </div>
            `;
            
            renderListaUsuariosAdmin();
        }

        function renderListaUsuariosAdmin() {
            const users = JSON.parse(localStorage.getItem('app_users') || '[]');
            const usersEscola = users.filter(u => u.schoolId == escolaAtualAdmin);

            const html = usersEscola.length > 0 ? `
                <table>
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Email</th>
                            <th>Perfil</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${usersEscola.map(u => `
                            <tr>
                                <td>${u.nome}</td>
                                <td>${u.email}</td>
                                <td><span class="badge ${u.role === 'gestor' ? 'badge-warning' : 'badge-info'}">${u.role || 'Professor'}</span></td>
                                <td>
                                    <button class="btn btn-secondary btn-sm" onclick="editarUsuarioAdmin(${u.id})">‚úèÔ∏è Editar</button>
                                    <button class="btn btn-danger btn-sm" onclick="excluirUsuarioAdmin(${u.id})">üóëÔ∏è</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : '<p class="empty-state">Nenhum usu√°rio vinculado a esta escola.</p>';

            document.getElementById('listaUsuariosEscolaAdmin').innerHTML = html;
        }

        function abrirModalUsuarioAdmin() {
            document.getElementById('adminUsuarioId').value = '';
            document.getElementById('adminUsuarioNome').value = '';
            document.getElementById('adminUsuarioEmail').value = '';
            document.getElementById('adminUsuarioSenha').value = '';
            document.getElementById('adminUsuarioRole').value = 'professor';
            document.getElementById('tituloModalUsuarioAdmin').textContent = 'Novo Usu√°rio';
            showModal('modalAdminUsuario');
        }

        function editarUsuarioAdmin(userId) {
            const users = JSON.parse(localStorage.getItem('app_users') || '[]');
            const user = users.find(u => u.id === userId);
            if (user) {
                document.getElementById('adminUsuarioId').value = user.id;
                document.getElementById('adminUsuarioNome').value = user.nome;
                document.getElementById('adminUsuarioEmail').value = user.email;
                document.getElementById('adminUsuarioSenha').value = ''; // Senha em branco para n√£o alterar
                document.getElementById('adminUsuarioRole').value = user.role || 'professor';
                document.getElementById('tituloModalUsuarioAdmin').textContent = 'Editar Usu√°rio';
                showModal('modalAdminUsuario');
            }
        }

        function salvarUsuarioAdmin(e) {
            e.preventDefault();
            const id = document.getElementById('adminUsuarioId').value;
            const nome = document.getElementById('adminUsuarioNome').value;
            const email = document.getElementById('adminUsuarioEmail').value;
            const senha = document.getElementById('adminUsuarioSenha').value;
            const role = document.getElementById('adminUsuarioRole').value;

            let users = JSON.parse(localStorage.getItem('app_users') || '[]');

            if (id) {
                const user = users.find(u => u.id == id);
                if (user) {
                    user.nome = nome;
                    user.email = email;
                    user.role = role;
                    if (senha) user.senha = senha;
                }
            } else {
                // Novo usu√°rio
                if (users.find(u => u.email === email)) {
                    alert('Email j√° cadastrado!');
                    return;
                }
                const newUser = {
                    id: Date.now(),
                    nome,
                    email,
                    senha: senha || '123456', // Senha padr√£o se vazia
                    role,
                    schoolId: escolaAtualAdmin,
                    mustChangePassword: true
                };
                users.push(newUser);
            }

            localStorage.setItem('app_users', JSON.stringify(users));
            closeModal('modalAdminUsuario');
            renderListaUsuariosAdmin();
        }

        function excluirUsuarioAdmin(id) {
            if (confirm('Tem certeza que deseja excluir este usu√°rio? Todos os dados dele ser√£o perdidos.')) {
                let users = JSON.parse(localStorage.getItem('app_users') || '[]');
                users = users.filter(u => u.id !== id);
                localStorage.setItem('app_users', JSON.stringify(users));
                // Limpar dados do usu√°rio
                localStorage.removeItem('app_data_' + id);
                renderListaUsuariosAdmin();
            }
        }

        // INICIALIZA√á√ÉO
        function init() {
            renderLogin();
        }

        // Inicializar quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>