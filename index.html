<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Sistema do Professor</title>
    <link rel="stylesheet" href="styles.css?v=3.1">
    <script src="shared.js?v=3.1"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>
    <!-- App Scripts -->
    <script src="core.js?v=3.1" defer></script>
    <script src="admin.js?v=3.1" defer></script>
    <script src="gestor.js?v=3.1" defer></script>
    <script src="app.js?v=3.1" defer></script>
</head>
<body>
    <!-- TELA DE LOGIN/CADASTRO -->
    <div id="authContainer" class="auth-screen">
        <div class="auth-box">
            <h2>üîê Login</h2>
            <form onsubmit="fazerLogin(event)">
                <label>Email: <input type="email" id="loginEmail" required></label>
                <label>Senha: 
                    <div class="password-wrapper">
                        <input type="password" id="loginSenha" required style="padding-right: 35px;">
                        <button type="button" class="toggle-password" onclick="toggleSenha('loginSenha', this)">üëÅÔ∏è</button>
                    </div>
                </label>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 10px;">Entrar</button>
            </form>
            <span class="auth-link" onclick="renderCadastro()">N√£o tem conta? Cadastre-se</span>
        </div>
    </div>

    <!-- ESTRUTURA DA APLICA√á√ÉO (Adicionada para suportar o JS) -->
    <div id="appContainer" style="display:none;">
        <div class="container">
            <header>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h1>üìö Sistema Escolar</h1>
                        <div id="painelSubtitle"></div>
                    </div>
                    <div id="headerUserArea" style="text-align: right;">
                        <div class="date-info" id="currentDate"></div>
                        <button class="btn btn-sm btn-danger" onclick="logout()" style="margin-top: 5px;">Sair</button>
                    </div>
                </div>
            </header>

            <nav>
                <!-- Bot√µes injetados via JS -->
            </nav>

            <!-- TELAS -->
            <div id="dashboard" class="screen">
                <div class="grid">
                    <div class="card">
                        <h2>üìÖ Aulas de Hoje</h2>
                        <div id="aulasHoje"></div>
                    </div>
                    <div class="card">
                        <h2>ü§ù Reuni√µes de Hoje</h2>
                        <div id="reunioesHoje"></div>
                    </div>
                    <div class="card">
                        <h2>üë• Tutorias/A√ß√µes</h2>
                        <div id="tutoriasHoje"></div>
                    </div>
                </div>
                <div class="card">
                    <h2>‚ö†Ô∏è Alertas</h2>
                    <div id="alertas"></div>
                </div>
            </div>

            <div id="turmas" class="screen">
                <div class="card">
                    <h2>Minhas Turmas</h2>
                    <button class="btn btn-primary" onclick="abrirModalNovaTurma()">+ Nova Turma</button>
                    <div id="listaTurmas" style="margin-top: 15px;"></div>
                </div>
            </div>

            <div id="tutoria" class="screen">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2>üéì Tutoria</h2>
                    </div>
                    <div class="grid">
                        <div>
                            <h3>Meus Tutorados</h3>
                            <div id="listaTutorados" style="margin-top: 10px;"></div>
                        </div>
                        <div>
                            <h3>Agenda de Tutoria</h3>
                            <button class="btn btn-primary btn-sm btn-registrar-extra" onclick="showModal('modalNovoEncontro')">+ Registrar Encontro</button>
                            <div id="listaEncontros" style="margin-top: 10px;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="agenda" class="screen">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0;">üìÖ Grade de Hor√°rios</h2>
                    </div>

                    <div id="containerGradeHoraria"></div>
                </div>
            </div>

            <!-- DETALHES -->
            <div id="turmaDetalhe" class="screen">
                <div class="card">
                    <button class="btn btn-secondary" onclick="showScreen('turmas')">‚Üê Voltar</button>
                    <h2 id="turmaDetalheTitulo" style="margin-top: 15px;">Detalhes da Turma</h2>
                    <div id="turmaStats" class="stats"></div>
                    
                    <nav style="margin-bottom: 20px; border-bottom: 1px solid #e2e8f0; padding-bottom: 10px;">
                        <!-- Tabs injetadas via JS -->
                    </nav>

                    <div id="tabEstudantes" class="turma-tab"></div>
                    <div id="tabChamada" class="turma-tab" style="display:none;"></div>
                    <div id="tabRegistros" class="turma-tab" style="display:none;"></div>
                    <div id="tabAtrasos" class="turma-tab" style="display:none;"></div>
                    <div id="tabTrabalhos" class="turma-tab" style="display:none;"></div>
                    <div id="tabCompensacoes" class="turma-tab" style="display:none;"></div>
                    <div id="tabOcorrencias" class="turma-tab" style="display:none;"></div>
                    <div id="tabMapeamento" class="turma-tab" style="display:none;">
                        <!-- Container onde o mapa √© renderizado -->
                        <div id="containerMapaVisual"></div>

                        <!-- Hist√≥rico de Altera√ß√µes -->
                        <div style="margin-top: 25px; border-top: 1px solid #e2e8f0; padding-top: 15px;">
                            <h3 style="font-size: 1.1em; color: #4a5568; margin-bottom: 10px;">üïí Hist√≥rico de Altera√ß√µes do Mapa</h3>
                            <ul id="listaHistoricoMapeamento" style="list-style: none; padding: 0; max-height: 200px; overflow-y: auto; font-size: 0.9em;"></ul>
                        </div>
                    </div>
                    <div id="tabConfiguracoes" class="turma-tab" style="display:none;"></div>
                </div>
            </div>

            <div id="tutoradoDetalhe" class="screen">
                <div class="card">
                    <button class="btn btn-secondary" onclick="showScreen('tutoria')">‚Üê Voltar</button>
                    <h2 id="tutoradoFichaNome" style="margin-top: 15px;">Nome do Tutorado</h2>
                    <div class="grid">
                        <div>
                            <h3>Agendamentos Futuros</h3>
                            <div id="tutoradoFichaAgendamentos"></div>
                        </div>
                        <div>
                            <h3>Hist√≥rico de Encontros</h3>
                            <div id="tutoradoFichaHistorico"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="estudanteDetalhe" class="screen">
                <div class="card">
                    <button class="btn btn-secondary" onclick="showScreen('turmaDetalhe')">‚Üê Voltar para Turma</button>
                    <h2 id="estudanteGeralNome" style="margin-top: 15px;">Nome do Estudante</h2>
                    
                    <div class="grid">
                        <div class="card" style="background: #f7fafc;">
                            <h3>Frequ√™ncia</h3>
                            <div id="estudanteGeralFrequencia"></div>
                        </div>
                        <div class="card" style="background: #fff5f5;">
                            <h3>Atrasos</h3>
                            <div id="estudanteGeralAtrasos"></div>
                        </div>
                    </div>

                    <h3>Notas e Trabalhos</h3>
                    <div id="estudanteGeralNotas"></div>

                    <h3>Ocorr√™ncias</h3>
                    <div id="estudanteGeralOcorrencias"></div>

                    <h3>Compensa√ß√µes</h3>
                    <div id="estudanteGeralCompensacoes"></div>
                </div>
            </div>

            <div id="relatorioImpressao" class="screen" style="background: white; min-height: 100vh;">
                <button class="btn btn-secondary no-print" onclick="showScreen('turmaDetalhe')" style="margin: 20px;">‚Üê Voltar</button>
                <button class="btn btn-primary no-print" onclick="window.print()" style="margin: 20px;">üñ®Ô∏è Imprimir</button>
                <div id="conteudoRelatorio"></div>
            </div>
            <div id="tutoriasGestor" class="screen"></div>
        </div>
    </div>

    <div id="adminContainer" style="display:none;">
        <div class="container">
            <header>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h1>üõ°Ô∏è Painel Super Admin</h1>
                    <button class="btn btn-danger" onclick="logout()">Sair</button>
                </div>
            </header>
            <div id="adminEscolasScreen">
                <div class="card">
                    <h2>Escolas Cadastradas</h2>
                    <button class="btn btn-primary" onclick="abrirModalEscola()">+ Nova Escola</button>
                    <div id="listaEscolasAdmin" style="margin-top: 15px;"></div>
                </div>
            </div>
            <div id="adminEscolaDetalheScreen" style="display:none;"></div>
        </div>
    </div>

    <!-- MODAIS (Placeholders essenciais) -->
    <div id="modalNovaTurma" class="modal"><div class="modal-content"><div class="modal-header"><h2 id="tituloModalTurma">Nova Turma</h2><button class="close-btn" onclick="closeModal('modalNovaTurma')">√ó</button></div><form onsubmit="salvarTurma(event)"><input type="hidden" id="turmaId"><div id="containerTurmaAnoInput"><label>Ano/S√©rie:<input type="text" id="turmaAno"></label></div><div id="containerTurmaAnoSelect" style="display:none;"><label>Turma:<select id="turmaAnoSelect"></select></label></div><div id="divTurmaDisciplina"><label>Disciplina:<input type="text" id="turmaDisciplina"></label></div><label>Turno:<select id="turmaTurno"><option value="Manh√£">Manh√£</option><option value="Tarde">Tarde</option><option value="Noite">Noite</option><option value="Integral">Integral</option></select></label><button type="submit" class="btn btn-primary">Salvar</button></form></div></div>
    
    <div id="modalNovoEstudante" class="modal"><div class="modal-content"><div class="modal-header"><h2>Novo Estudante</h2><button class="close-btn" onclick="closeModal('modalNovoEstudante')">√ó</button></div><form onsubmit="salvarEstudante(event)"><label>Nome Completo:<input type="text" id="estudanteNome" required></label><label>Status:<select id="estudanteStatus"><option value="Ativo">Ativo</option><option value="Transferido">Transferido</option><option value="Baixa-Transferencia">Baixa-Transferencia</option><option value="Remanejado">Remanejado</option><option value="NCOM">NCOM</option></select></label><button type="submit" class="btn btn-primary">Salvar</button></form></div></div>
    
    <div id="modalImportarEstudantes" class="modal"><div class="modal-content"><div class="modal-header"><h2>Importar CSV</h2><button class="close-btn" onclick="closeModal('modalImportarEstudantes')">√ó</button></div><form onsubmit="importarEstudantes(event)"><label>Arquivo CSV:<input type="file" id="arquivoEstudantes" accept=".csv" required></label><p style="font-size:12px; color:#666;">Formato: Nome Completo;Status</p><button type="submit" class="btn btn-success">Importar</button></form></div></div>

    <div id="modalNovoTrabalho" class="modal"><div class="modal-content"><div class="modal-header"><h2>Novo Trabalho</h2><button class="close-btn" onclick="closeModal('modalNovoTrabalho')">√ó</button></div><form onsubmit="salvarTrabalho(event)"><label>T√≠tulo:<input type="text" id="trabalhoTitulo" required></label><label>Peso:<input type="number" id="trabalhoPeso" step="0.1" value="1.0" required></label><button type="submit" class="btn btn-primary">Salvar</button></form></div></div>
    
    <div id="modalLancarNotas" class="modal"><div class="modal-content"><div class="modal-header"><h2>Lan√ßar Notas</h2><button class="close-btn" onclick="closeModal('modalLancarNotas')">√ó</button></div><div id="conteudoLancarNotas"></div></div></div>

    <div id="modalNovoEvento" class="modal"><div class="modal-content"><div class="modal-header"><h2>Novo Evento</h2><button class="close-btn" onclick="closeModal('modalNovoEvento')">√ó</button></div><form onsubmit="salvarEvento(event)"><label>Tipo:<select id="eventoTipo" required><option value="Reuni√£o">Reuni√£o</option><option value="Aula">Aula</option><option value="Pessoal">Pessoal</option></select></label><div id="divEventoTurma" style="display:none;"><label>Turma:<select id="eventoTurmaSelect"></select></label></div><label>T√≠tulo:<input type="text" id="eventoTitulo" required></label><div class="form-row"><label>Data:<input type="date" id="eventoData" required></label><label>In√≠cio:<input type="time" id="eventoHoraInicio" required></label><label>Fim:<input type="time" id="eventoHoraFim" required></label></div><label>Anota√ß√µes:<textarea id="eventoAnotacoes"></textarea></label><label>Recorr√™ncia:<select id="eventoRecorrenciaTipo" onchange="toggleRecorrenciaUI()"><option value="nao">N√£o repetir</option><option value="semanal">Semanalmente</option><option value="mensal">Mensalmente</option><option value="personalizado">Personalizado</option></select></label><div id="divRecorrenciaFim" style="display:none;"><label>Repetir at√©:<input type="date" id="eventoRecorrenciaFim"></label></div><div id="divRecorrenciaPersonalizada" style="display:none;"><label>Dias da Semana:</label><div style="display:flex; gap:5px;"><label><input type="checkbox" name="diaSemana" value="1"> Seg</label><label><input type="checkbox" name="diaSemana" value="2"> Ter</label><label><input type="checkbox" name="diaSemana" value="3"> Qua</label><label><input type="checkbox" name="diaSemana" value="4"> Qui</label><label><input type="checkbox" name="diaSemana" value="5"> Sex</label></div></div><button type="submit" class="btn btn-primary">Salvar</button></form></div></div>

    <div id="modalDetalhesEvento" class="modal"><div class="modal-content"><div class="modal-header"><h2>Detalhes do Evento</h2><button class="close-btn" onclick="closeModal('modalDetalhesEvento')">√ó</button></div><form onsubmit="salvarDetalhesEvento(event)"><input type="hidden" id="detalheEventoId"><input type="hidden" id="detalheEventoTipo"><label>T√≠tulo:<input type="text" id="detalheEventoTitulo"></label><div class="form-row"><label>Data:<input type="date" id="detalheEventoData"></label><label>In√≠cio:<input type="time" id="detalheEventoInicio"></label><label>Fim:<input type="time" id="detalheEventoFim"></label></div><label>Anota√ß√µes:<textarea id="detalheEventoAnotacoes"></textarea></label><div style="display:flex; justify-content:space-between; margin-top:15px;"><button type="button" class="btn btn-danger" onclick="excluirEventoAtual()">Excluir</button><button type="submit" class="btn btn-primary">Salvar Altera√ß√µes</button></div></form></div></div>

    <div id="modalNovoTutorado" class="modal"><div class="modal-content"><div class="modal-header"><h2>Novo Tutorado</h2><button class="close-btn" onclick="closeModal('modalNovoTutorado')">√ó</button></div><form onsubmit="salvarTutorado(event)"><label>Turma:<select id="tutoradoTurmaSelect" onchange="carregarEstudantesTutorado()" required></select></label><label>Estudante:<select id="tutoradoEstudanteSelect" required disabled></select></label><button type="submit" class="btn btn-primary">Salvar</button></form></div></div>

    <div id="modalNovoEncontro" class="modal"><div class="modal-content"><div class="modal-header"><h2>Registrar Encontro</h2><button class="close-btn" onclick="closeModal('modalNovoEncontro')">√ó</button></div><form onsubmit="salvarEncontro(event)"><label>Tutorado:<select id="encontroTutorado" required></select></label><label>Data:<input type="date" id="encontroData" required></label><label>Tema:<input type="text" id="encontroTema" required></label><label>Resumo:<textarea id="encontroResumo" required></textarea></label><button type="submit" class="btn btn-primary">Salvar</button></form></div></div>

    <div id="modalGerarAgendamento" class="modal"><div class="modal-content"><div class="modal-header"><h2>Agendamento Autom√°tico</h2><button class="close-btn" onclick="closeModal('modalGerarAgendamento')">√ó</button></div><form onsubmit="previewHorariosAuto(event)"><label>In√≠cio:<input type="date" id="agendamentoInicio" required></label><label>Hora In√≠cio (se manual):<input type="time" id="agendamentoHoraInicio"></label><label>Dura√ß√£o (min):<input type="number" id="agendamentoDuracao" value="20"></label><label>Recorr√™ncia:<select id="agendamentoRecorrenciaTipo" onchange="toggleAgendamentoRecorrenciaUI()"><option value="nao">Apenas uma vez</option><option value="semanal">Semanal</option><option value="mensal">Mensal</option><option value="personalizado">Dias Espec√≠ficos</option></select></label><div id="divAgendamentoRecorrenciaFim" style="display:none;"><label>At√©:<input type="date" id="agendamentoRecorrenciaFim"></label></div><div id="divAgendamentoRecorrenciaPersonalizada" style="display:none;"><label>Dias:</label><div style="display:flex; gap:5px;"><label><input type="checkbox" name="diaAgendamento" value="1"> Seg</label><label><input type="checkbox" name="diaAgendamento" value="2"> Ter</label><label><input type="checkbox" name="diaAgendamento" value="3"> Qua</label><label><input type="checkbox" name="diaAgendamento" value="4"> Qui</label><label><input type="checkbox" name="diaAgendamento" value="5"> Sex</label></div></div><label><input type="checkbox" id="usarGradeTutoria"> Usar Grade de Tutoria da Escola</label><button type="submit" class="btn btn-secondary">Gerar Preview</button></form><div id="areaPreviewAgendamento" style="display:none; margin-top:15px;"><div style="display:flex; justify-content:space-between;"><h4>Preview (<span id="qtdHorariosGerados">0</span> hor√°rios)</h4><div><button onclick="mudarSemanaPreview(-1)">‚Üê</button><span id="previewSemanaTexto" style="font-size:12px;"></span><button onclick="mudarSemanaPreview(1)">‚Üí</button></div></div><div id="listaHorariosPreview" style="max-height:150px; overflow-y:auto; border:1px solid #eee;"></div><button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="confirmarDistribuicaoAuto()">Confirmar Agendamento</button></div></div></div>

    <div id="modalListaAgendamentos" class="modal"><div class="modal-content"><div class="modal-header"><h2>Agendamentos Futuros</h2><button class="close-btn" onclick="closeModal('modalListaAgendamentos')">√ó</button></div><div id="listaAgendamentosConteudo"></div></div></div>

    <div id="modalRelatorioFaltas" class="modal"><div class="modal-content"><div class="modal-header"><h2>Relat√≥rio de Faltas</h2><button class="close-btn" onclick="closeModal('modalRelatorioFaltas')">√ó</button></div><div id="conteudoRelatorioFaltas"></div></div></div>

    <div id="modalNovoRegistroGestao" class="modal"><div class="modal-content"><div class="modal-header"><h2>Novo Registro Administrativo</h2><button class="close-btn" onclick="closeModal('modalNovoRegistroGestao')">√ó</button></div><div id="formRegistroGestaoConteudo"></div></div></div>

    <div id="modalAdminEscola" class="modal"><div class="modal-content"><div class="modal-header"><h2 id="tituloModalEscola">Escola</h2><button class="close-btn" onclick="closeModal('modalAdminEscola')">√ó</button></div><form onsubmit="salvarEscola(event)"><input type="hidden" id="adminEscolaId"><label>Nome:<input type="text" id="adminEscolaNome" required></label><label>Endere√ßo:<input type="text" id="adminEscolaEndereco"></label><button type="submit" class="btn btn-primary">Salvar</button></form></div></div>

    <div id="modalAdminUsuario" class="modal"><div class="modal-content"><div class="modal-header"><h2 id="tituloModalUsuarioAdmin">Usu√°rio</h2><button class="close-btn" onclick="closeModal('modalAdminUsuario')">√ó</button></div><form onsubmit="salvarUsuarioAdmin(event)"><input type="hidden" id="adminUsuarioId"><label>Nome:<input type="text" id="adminUsuarioNome" required></label><label>Email:<input type="email" id="adminUsuarioEmail" required></label><label>Senha:<input type="text" id="adminUsuarioSenha" placeholder="Deixe em branco para manter"></label><label>Perfil:<select id="adminUsuarioRole"><option value="professor">Professor</option><option value="gestor">Gestor</option></select></label><button type="submit" class="btn btn-primary">Salvar</button></form></div></div>

    <div id="modalNovoAviso" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>üì¢ Novo Aviso para Mural</h2><button class="close-btn" onclick="closeModal('modalNovoAviso')">√ó</button></div>
            <div style="margin-bottom:15px;">
                <label>Mensagem do Aviso:</label>
                <textarea id="textoNovoAviso" rows="4" style="width:100%; margin-top:5px;" placeholder="Ex: Reuni√£o de pais na sexta-feira..."></textarea>
            </div>
            <label>Publicar para as Turmas:</label>
            <div id="listaTurmasAviso" style="margin-bottom:15px;"></div>
            <button class="btn btn-primary" onclick="salvarAviso()">Publicar Aviso</button>
        </div>
    </div>

    <div id="modalDetalheFaltasDia" class="modal"><div class="modal-content"><div class="modal-header" style="display:none;"></div><button class="close-btn" onclick="closeModal('modalDetalheFaltasDia')" style="position:absolute; right:15px; top:15px;">√ó</button><div id="conteudoDetalheFaltasDia" style="margin-top:10px;"></div></div></div>

    <!-- Modal Novo Registro de Aula (Professor) -->
    <div id="modalNovoRegistroAula" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>Novo Registro de Aula</h2><button class="close-btn" onclick="closeModal('modalNovoRegistroAula')">√ó</button></div>
            <form onsubmit="salvarRegistroAula(event)">
                <label>Data:<input type="date" id="regAulaData" required></label>
                <label>Conte√∫do / Observa√ß√£o:<textarea id="regAulaConteudo" rows="5" required placeholder="Descreva o conte√∫do ministrado ou observa√ß√µes da aula..."></textarea></label>
                <button type="submit" class="btn btn-primary">Salvar Registro</button>
            </form>
        </div>
    </div>
</body>
</html>
